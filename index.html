<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<title>SeedOrders2 ‚Äì Zam√≥wienia & Raport odbior√≥w</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
:root{--bg:#f9fafb;--card:#fff;--txt:#111;--muted:#6b7280;--line:#e5e7eb;--ok:#0a7a2a;--err:#b00020;--warn:#9a6b00}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--txt)}
.wrap{max-width:1150px;margin:22px auto;padding:0 16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 1px 3px rgba(0,0,0,.05)}
h1{font-size:22px;margin:0 0 8px}
h3{margin:0 0 10px}
button,input,select{padding:8px 10px;border:1px solid var(--line);border-radius:8px;font-size:14px}
button{cursor:pointer;background:#111;color:#fff}
button.secondary{background:#fff;color:#111}
button.danger{background:#b00020}
button.warning{background:#9a6b00}
.status{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;color:#fff}
.s-none{background:var(--err)}
.s-part{background:var(--warn)}
.s-full{background:var(--ok)}
table{width:100%;border-collapse:collapse}
th,td{border-top:1px solid var(--line);padding:6px 10px;text-align:left;vertical-align:middle}
th{background:#f3f4f6}
.right{text-align:right}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.summary{margin-top:10px;padding:10px;border:1px solid var(--line);border-radius:8px;background:#f8fafc}
pre{background:#0b1220;color:#e6edf3;padding:12px;border-radius:10px;max-height:55vh;overflow:auto}
.print-only{display:none}
@media print{
  .no-print{display:none!important}
  .print-only{display:block}
  .card{border:none;box-shadow:none;margin:0;padding:0}
  body{background:#fff}
  th{background:#eee}
}
</style>
</head>
<body>
<div class="wrap">
  <h1>üåæ SeedOrders2</h1>

  <div class="card no-print">
    <div class="toolbar">
      <button onclick="showClients()">üìã Klienci</button>
      <button onclick="showProducts()">üå± Produkty</button>
      <button onclick="showOrders()">üì¶ Zam√≥wienia</button>
    </div>
  </div>

  <div id="view"></div>

  <div class="card no-print">
    <h3>Log systemowy</h3>
    <pre id="log">Gotowe.</pre>
  </div>
</div>

<script>
// === PODMIE≈É NA SWOJE (bez / na ko≈Ñcu, bez // na ko≈Ñcu klucza) ===
const SUPABASE_URL = 'https://zseqkyjcqkuvrqxluihs.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzZXFreWpjcWt1dnJxeGx1aWhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNDk2NjUsImV4cCI6MjA3NjkyNTY2NX0.ubbYQzYWiMyETohwKRnVQZaZRoIA-zwiX2YsY8TPsDk';

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const logOK = (t,d)=>document.getElementById('log').textContent='‚úÖ '+t+'\n\n'+JSON.stringify(d,null,2);
const logERR = (t,e)=>document.getElementById('log').textContent='‚ùå '+t+': '+(e?.message||e);
const esc = s => (s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

// =================== KLIENCI ===================
async function showClients(){
  const {data,error}=await sb.from('clients').select('*').order('created_at',{ascending:false});
  if(error) return logERR('Klienci',error);
  const rows=(data||[]).map(c=>`<tr>
    <td>${esc(c.name)}</td><td>${esc(c.phone||'')}</td><td>${esc(c.email||'')}</td><td>${esc(c.address||'')}</td>
    <td class="right">
      <button onclick="editClient('${c.id}')">‚úèÔ∏è</button>
      <button class="danger" onclick="deleteClient('${c.id}')">üóë</button>
    </td>
  </tr>`).join('');
  document.getElementById('view').innerHTML=`
    <div class="card">
      <h3>Klienci</h3>
      <div class="toolbar">
        <input id="c_name" placeholder="Nazwa" style="min-width:200px">
        <input id="c_phone" placeholder="Telefon">
        <input id="c_email" placeholder="Email">
        <input id="c_address" placeholder="Adres" style="min-width:260px">
        <button onclick="addClient()">‚ûï Dodaj klienta</button>
      </div>
      <table style="margin-top:8px">
        <thead><tr><th>Nazwa</th><th>Tel</th><th>Email</th><th>Adres</th><th></th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
  logOK('Za≈Çadowano klient√≥w',{count:data?.length||0});
}
function _v(id){return document.getElementById(id).value.trim();}
async function addClient(){
  const name=_v('c_name'); if(!name) return alert('Podaj nazwƒô klienta.');
  const {data,error}=await sb.from('clients').insert([{name,phone:_v('c_phone'),email:_v('c_email'),address:_v('c_address')}]).select();
  if(error) return logERR('Dodawanie klienta',error); logOK('Dodano klienta',data); showClients();
}
async function editClient(id){
  const {data}=await sb.from('clients').select('*').eq('id',id).single();
  const n=prompt('Nazwa',data.name); const p=prompt('Telefon',data.phone); const e=prompt('Email',data.email); const a=prompt('Adres',data.address);
  await sb.from('clients').update({name:n,phone:p,email:e,address:a}).eq('id',id); showClients();
}
async function deleteClient(id){ if(confirm('UsunƒÖƒá klienta?')){ await sb.from('clients').delete().eq('id',id); showClients(); } }

// =================== PRODUKTY ===================
async function showProducts(){
  const {data,error}=await sb.from('products').select('*').order('created_at',{ascending:false});
  if(error) return logERR('Produkty',error);
  const rows=(data||[]).map(p=>`<tr>
    <td>${esc(p.name)}</td><td>${esc(p.category||'')}</td><td class="right">${Number(p.price||0).toFixed(2)}</td>
    <td class="right">${p.stock??0}</td><td>${esc(p.color||'')}</td>
    <td class="right">
      <button onclick="editProduct('${p.id}')">‚úèÔ∏è</button>
      <button class="danger" onclick="deleteProduct('${p.id}')">üóë</button>
    </td>
  </tr>`).join('');
  document.getElementById('view').innerHTML=`
    <div class="card">
      <h3>Produkty</h3>
      <div class="toolbar">
        <input id="p_name" placeholder="Nazwa" style="min-width:200px">
        <input id="p_category" placeholder="Kategoria">
        <input id="p_price" type="number" step="0.01" min="0" placeholder="Cena">
        <input id="p_stock" type="number" step="1" min="0" placeholder="Stan">
        <input id="p_color" placeholder="Kolor">
        <button onclick="addProduct()">‚ûï Dodaj produkt</button>
      </div>
      <table style="margin-top:8px">
        <thead><tr><th>Nazwa</th><th>Kategoria</th><th class="right">Cena</th><th class="right">Stan</th><th>Kolor</th><th></th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
  logOK('Za≈Çadowano produkty',{count:data?.length||0});
}
async function addProduct(){
  const name=_v('p_name'); if(!name) return alert('Podaj nazwƒô produktu.');
  const price=Number((_v('p_price')||'0').replace(',','.')), stock=Number(_v('p_stock')||'0');
  const {data,error}=await sb.from('products').insert([{
    name, category:_v('p_category'), price, stock, color:_v('p_color')
  }]).select();
  if(error) return logERR('Dodawanie produktu',error); logOK('Dodano produkt',data); showProducts();
}
async function editProduct(id){
  const {data}=await sb.from('products').select('*').eq('id',id).single();
  const n=prompt('Nazwa',data.name); const k=prompt('Kategoria',data.category);
  const c=parseFloat(prompt('Cena',data.price)); const s=parseInt(prompt('Stan',data.stock)); const col=prompt('Kolor',data.color);
  await sb.from('products').update({name:n,category:k,price:c,stock:s,color:col}).eq('id',id); showProducts();
}
async function deleteProduct(id){ if(confirm('UsunƒÖƒá produkt?')){ await sb.from('products').delete().eq('id',id); showProducts(); } }

// ========== ZAM√ìWIENIA + RAPORT / FILTRY / CSV / PDF ==========
// --- koszyk/utworzenie zam√≥wienia ---
let cart=[]; // {product_id,name,unit_price,qty}
const productsCache=new Map();

function updateUnitInfo(){
  const pid=document.getElementById('o_product')?.value;
  const p=productsCache.get(pid);
  const el=document.getElementById('unitInfo'); if(el) el.textContent=p?`cena: ${Number(p.price).toFixed(2)}`:'‚Äî';
}
function renderCartRows(){
  return cart.map((l,idx)=>`
    <tr>
      <td>${esc(l.name)}</td>
      <td class="right">${l.unit_price.toFixed(2)}</td>
      <td class="right">${l.qty}</td>
      <td class="right">${(l.qty*l.unit_price).toFixed(2)}</td>
      <td class="right"><button class="danger" onclick="removeLine(${idx})">Usu≈Ñ</button></td>
    </tr>`).join('');
}
function refreshCartUI(){
  const tbody=document.querySelector('#cartTable tbody'); if(!tbody) return;
  tbody.innerHTML=renderCartRows();
  const total=cart.reduce((s,l)=>s+l.qty*l.unit_price,0);
  const tEl=document.getElementById('cartTotal'); if(tEl) tEl.textContent=total.toFixed(2);
}
function addLine(){
  const pid=document.getElementById('o_product').value;
  const qty=Number(document.getElementById('o_qty').value||'1');
  if(!pid) return alert('Wybierz produkt.'); if(!qty||qty<1) return alert('Ilo≈õƒá musi byƒá ‚â• 1.');
  const p=productsCache.get(pid);
  cart.push({product_id:pid,name:p.name,unit_price:Number(p.price),qty});
  refreshCartUI();
}
function removeLine(idx){ cart.splice(idx,1); refreshCartUI(); }
function clearCart(){ cart.length=0; refreshCartUI(); }

async function saveOrder(){
  const client_id=document.getElementById('o_client').value;
  if(!client_id) return alert('Wybierz klienta.');
  if(cart.length===0) return alert('Koszyk jest pusty.');

  const total=Number(cart.reduce((s,l)=>s+l.qty*l.unit_price,0).toFixed(2));
  const {data:ord,error:e1}=await sb.from('orders')
    .insert([{client_id,order_date:new Date().toISOString().slice(0,10),total_amount:total}])
    .select('id');
  if(e1) return logERR('Tworzenie zam√≥wienia',e1);
  const order_id=ord[0].id;

  const lines=cart.map(l=>({order_id,product_id:l.product_id,quantity:l.qty,unit_price:l.unit_price,fulfilled_qty:0}));
  const {error:e2}=await sb.from('order_items').insert(lines);
  if(e2) return logERR('Dodawanie pozycji',e2);

  logOK('Zam√≥wienie zapisane',{order_id,pozycji:lines.length});
  clearCart();
  showOrders();
}

// --- raport/lista ---
let _ordersRaw=[]; let _ordersFiltered=[];
function sClass(q,f){ if((f||0)<=0) return 's-none'; if((f||0)<q) return 's-part'; return 's-full'; }
function sLbl(q,f){ if((f||0)<=0) return 'Nieodebrane'; if((f||0)<q) return `Czƒô≈õciowo (${f}/${q})`; return `Odebrane (${q})`; }

async function showOrders(){
  // 1) formularz ‚Äì klienci i produkty
  const [clients,products]=await Promise.all([
    sb.from('clients').select('id,name').order('name'),
    sb.from('products').select('id,name,price').order('name')
  ]);
  if(clients.error) return logERR('Klienci',clients.error);
  if(products.error) return logERR('Produkty',products.error);

  productsCache.clear();
  (products.data||[]).forEach(p=>productsCache.set(p.id,{name:p.name,price:Number(p.price)}));

  // 2) dane zam√≥wie≈Ñ
  const {data:errorData,error:eOrd}=await sb.from('orders')
    .select(`id,order_date,total_amount,clients(name),order_items(id,quantity,fulfilled_qty,unit_price,products(name))`)
    .order('created_at',{ascending:false});
  if(eOrd) return logERR('Zam√≥wienia',eOrd);
  _ordersRaw=errorData||[]; _ordersFiltered=_ordersRaw.slice();

  // 3) UI: formularz + raport/filtry + lista
  document.getElementById('view').innerHTML=`
    <div class="card">
      <h3>üßæ Utw√≥rz zam√≥wienie</h3>
      <div class="toolbar" style="gap:10px">
        <label>Klient:</label>
        <select id="o_client" style="min-width:260px">
          <option value="">(wybierz)</option>
          ${(clients.data||[]).map(c=>`<option value="${c.id}">${esc(c.name||c.id)}</option>`).join('')}
        </select>
        <label>Produkt:</label>
        <select id="o_product" style="min-width:260px" onchange="updateUnitInfo()">
          <option value="">(wybierz)</option>
          ${(products.data||[]).map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join('')}
        </select>
        <span id="unitInfo" class="status s-part" style="background:#444">‚Äî</span>
        <input id="o_qty" type="number" min="1" value="1" style="width:120px">
        <button onclick="addLine()">‚ûï Dodaj pozycjƒô</button>
      </div>
      <table id="cartTable" style="margin-top:8px">
        <thead><tr><th>Produkt</th><th class="right">Cena</th><th class="right">Ilo≈õƒá</th><th class="right">Suma</th><th class="right">Akcje</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><th colspan="3" class="right">Razem</th><th class="right" id="cartTotal">0.00</th><th class="right">
          <button onclick="saveOrder()">üíæ Zapisz zam√≥wienie</button>
          <button class="secondary" onclick="clearCart()">Wyczy≈õƒá koszyk</button>
        </th></tr></tfoot>
      </table>
    </div>

    <div id="reportArea"></div>
  `;
  updateUnitInfo(); refreshCartUI();
  renderOrdersUI();
  logOK('Za≈Çadowano zam√≥wienia',{count:_ordersRaw.length});
}

function applyFilters(){
  const status=document.getElementById('fltStatus').value;
  const df=document.getElementById('fltFrom').value;
  const dt=document.getElementById('fltTo').value;

  _ordersFiltered=_ordersRaw.filter(o=>{
    if(df && o.order_date<df) return false;
    if(dt && o.order_date>dt) return false;
    const someOpen=o.order_items.some(i=>(i.fulfilled_qty||0)<i.quantity);
    const somePart=o.order_items.some(i=>(i.fulfilled_qty||0)>0 && (i.fulfilled_qty||0)<i.quantity);
    const allFull=o.order_items.length>0 && o.order_items.every(i=>(i.fulfilled_qty||0)===i.quantity);
    if(status==='open') return someOpen;
    if(status==='partial') return somePart;
    if(status==='full') return allFull;
    return true;
  });

  renderOrdersUI();
}

function calcSummary(rows){
  let totalQty=0,totalFul=0,pending=0;
  rows.forEach(o=>{
    (o.order_items||[]).forEach(i=>{
      totalQty+=i.quantity;
      totalFul+=(i.fulfilled_qty||0);
      if((i.fulfilled_qty||0)<i.quantity) pending++;
    });
  });
  const percent=totalQty?(100*totalFul/totalQty):0;
  return {totalQty,totalFulfilled:totalFul,pending,percent};
}

function renderOrdersUI(){
  const summary=calcSummary(_ordersFiltered);
  const ordersHTML=_ordersFiltered.map(renderOrderBlock).join('')||'<p>Brak zam√≥wie≈Ñ.</p>';
  document.getElementById('reportArea').innerHTML=`
    <div class="card no-print">
      <h3>Raport odbior√≥w</h3>
      <div class="toolbar">
        <label>Filtr statusu:</label>
        <select id="fltStatus" onchange="applyFilters()">
          <option value="all">Wszystkie</option>
          <option value="open">Tylko nieodebrane</option>
          <option value="partial">Czƒô≈õciowe</option>
          <option value="full">W pe≈Çni odebrane</option>
        </select>
        <label>Zakres dat:</label>
        <input id="fltFrom" type="date" onchange="applyFilters()">
        <input id="fltTo" type="date" onchange="applyFilters()">
        <button onclick="exportCSV()">‚¨áÔ∏è Eksport CSV</button>
        <button onclick="printPDF()">üñ®Ô∏è Drukuj PDF</button>
      </div>
      <div class="summary">
        <b>≈ÅƒÖcznie odebrano:</b> ${summary.totalFulfilled} / ${summary.totalQty} (${summary.percent.toFixed(1)}%)<br>
        <b>Pozycji nieodebranych:</b> ${summary.pending}
      </div>
    </div>

    <div class="card print-only">
      <h3>Raport odbior√≥w ‚Äì wydruk</h3>
      <div><b>≈ÅƒÖcznie:</b> ${summary.totalFulfilled} / ${summary.totalQty} (${summary.percent.toFixed(1)}%) ‚Ä¢ Nieodebranych: ${summary.pending}</div>
    </div>

    ${ordersHTML}
  `;
}

function renderOrderBlock(o){
  const items=(o.order_items||[]).map(i=>{
    const cls=sClass(i.quantity,i.fulfilled_qty||0), lbl=sLbl(i.quantity,i.fulfilled_qty||0);
    return `<tr>
      <td>${esc(i.products?.name||'')}</td>
      <td class="right">${i.quantity}</td>
      <td class="right">${i.fulfilled_qty||0}</td>
      <td class="right">${(i.unit_price||0).toFixed(2)}</td>
      <td class="right"><span class="status ${cls}">${lbl}</span></td>
      <td class="right no-print">
        <button onclick="adjFulfilled('${i.id}',-1)">-1</button>
        <button onclick="adjFulfilled('${i.id}',1)">+1</button>
        <button class="warning" onclick="fulfillAll('${i.id}',${i.quantity})">Odbierz wszystko</button>
      </td>
    </tr>`;
  }).join('');
  return `<div class="card">
    <div><b>${o.order_date||''}</b> | ${esc(o.clients?.name||'‚Äî')} | <b>Razem: ${o.total_amount??''}</b></div>
    <table style="margin-top:6px">
      <thead><tr><th>Produkt</th><th class="right">Ilo≈õƒá</th><th class="right">Odebrano</th><th class="right">Cena</th><th class="right">Status</th><th class="right no-print">Odbi√≥r</th></tr></thead>
      <tbody>${items}</tbody>
    </table>
  </div>`;
}

async function adjFulfilled(itemId,delta){
  const {data,error}=await sb.from('order_items').select('quantity,fulfilled_qty').eq('id',itemId).single();
  if(error) return logERR('Pobieranie pozycji',error);
  let n=(data.fulfilled_qty||0)+delta; if(n<0)n=0; if(n>data.quantity)n=data.quantity;
  await sb.from('order_items').update({fulfilled_qty:n}).eq('id',itemId);
  applyFilters();
}
async function fulfillAll(itemId,qty){ await sb.from('order_items').update({fulfilled_qty:qty}).eq('id',itemId); applyFilters(); }

// === Export CSV (widok po filtrach) ===
function exportCSV(){
  const rows=[['order_id','order_date','client','product','quantity','fulfilled_qty','unit_price','status']];
  _ordersFiltered.forEach(o=>{
    (o.order_items||[]).forEach(i=>{
      rows.push([o.id,o.order_date,(o.clients?.name||''),(i.products?.name||''),i.quantity,(i.fulfilled_qty||0),(i.unit_price||0),sLbl(i.quantity,i.fulfilled_qty||0)]);
    });
  });
  const csv=rows.map(r=>r.map(v=>{const s=(v==null?'':String(v)); return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s}).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download=`seedorders2-raport-${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click();
  document.body.removeChild(a); URL.revokeObjectURL(url);
}
// === Druk PDF przez okno drukowania ===
function printPDF(){ window.print(); }

// start
showOrders();
</script>
</body>
</html>
