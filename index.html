<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SeedOrders ‚Äî wsp√≥lna baza</title>
<style>
  :root{--bg:#0b1020;--card:#121a2a;--ink:#e6f0ff;--muted:#a8b3c7;--brand:#3aa675;--line:#24314a;--ok:#2ea043;--warn:#e3b341;--bad:#d73a49}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px system-ui,Segoe UI,Roboto,Arial}
  h2{margin:18px 0 10px}
  .wrap{max-width:1180px;margin:20px auto;padding:0 12px}
  .row{display:grid;gap:12px}
  @media(min-width:980px){.row{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  label{display:block;font-size:12px;color:var(--muted);margin:6px 0 4px}
  input,select,button,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0f1524;color:var(--ink)}
  button{cursor:pointer}
  .btn{background:#162037;border-color:#2b3a5b}
  .btn.primary{background:var(--brand);border-color:transparent;color:#03140d;font-weight:700}
  .btn.danger{background:#4a1620;border-color:#6b1e27}
  .bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .grid{width:100%;border-collapse:collapse;margin-top:10px}
  .grid th,.grid td{border:1px solid var(--line);padding:8px;text-align:left}
  .tight td{white-space:nowrap}
  .right{text-align:right}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;color:#06130e;background:#234e3a}
  .link{cursor:pointer;color:#8bd4ff}
  .muted{color:var(--muted)}
  .status{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:600}
  .s-new{background:#15311f;color:#79d8a8}
  .s-part{background:#2f270a;color:#f0d37a}
  .s-done{background:#2b1315;color:#f5b1b6}
  .k-new {border-color:#244e3b}
  .k-part{border-color:#5b4a17;background:#221b08}
  .k-done{border-color:#6b1e27;background:#201015}
  .iconbtn{padding:6px 10px}
</style>
</head>
<body>
<div class="wrap">
  <div class="bar" style="justify-content:space-between;margin-bottom:8px">
    <div style="font-weight:800">üå± SeedOrders ‚Äî wsp√≥lna baza</div>
    <div>Status: <span id="online" class="pill">offline</span></div>
  </div>

  <!-- CENNIK -->
  <div class="card">
    <div class="bar" style="justify-content:space-between">
      <h2 style="margin:0">Cennik</h2>
      <span class="link" id="toggle_prices">Ukryj</span>
    </div>
    <div id="prices_section">
      <div class="bar">
        <label><input type="checkbox" id="pf_rzepak" checked> Rzepak</label>
        <label><input type="checkbox" id="pf_kuk" checked> Kukurydza</label>
        <label><input type="checkbox" id="pf_zboza" checked> Zbo≈ºa</label>
        <label><input type="checkbox" id="pf_trawy" checked> Trawy</label>
        <label><input type="checkbox" id="pf_inne" checked> Inne</label>
        <button class="btn" id="p_refresh">Od≈õwie≈º</button>
      </div>
      <div class="bar">
        <select id="p_kat">
          <option>Rzepak</option>
          <option selected>Kukurydza</option>
          <option>Zbo≈ºa</option>
          <option>Trawy</option>
          <option>Inne</option>
        </select>
        <input id="p_odm" placeholder="Odmiana">
        <input id="p_cena" type="number" step="0.01" placeholder="Cena">
        <input id="p_dos" placeholder="Dostawca (opcjonalnie)">
        <button class="btn primary" id="p_save">Zapisz</button>
        <button class="btn" id="p_cancel" style="display:none">Anuluj edycjƒô</button>
      </div>
      <table class="grid tight" id="price_tbl">
        <thead><tr><th>Odmiana</th><th>Kategoria</th><th class="right">Cena</th><th>Dostawca</th><th>Akcje</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- KONTRAHENCI -->
  <div class="card" style="margin-top:12px">
    <div class="bar" style="justify-content:space-between">
      <h2 style="margin:0">Kontrahenci</h2>
      <span class="link" id="toggle_clients">Ukryj</span>
    </div>
    <div id="clients_section">
      <div class="bar">
        <input id="c_name" placeholder="Nazwa">
        <input id="c_phone" placeholder="Telefon">
        <input id="c_addr" placeholder="Adres">
        <button class="btn primary" id="c_save">Zapisz</button>
        <button class="btn" id="c_cancel" style="display:none">Anuluj edycjƒô</button>
      </div>
      <div class="bar" style="margin-top:6px">
        <input id="c_filter" placeholder="Szukaj..."/>
        <button class="btn" id="c_refresh">Od≈õwie≈º listƒô</button>
      </div>
      <table class="grid tight" id="cli_tbl">
        <thead><tr><th>Nazwa</th><th>Telefon</th><th>Adres</th><th>Akcje</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ZAM√ìWIENIA -->
  <div class="card" style="margin-top:12px">
    <h2>Dodaj zam√≥wienie</h2>
    <div class="bar">
      <select id="o_client"></select>
      <input id="o_phone" placeholder="Telefon (auto)" disabled>
      <input id="o_notes" placeholder="Uwagi (opcjonalnie)">
      <button class="btn primary" id="o_add">Utw√≥rz zam√≥wienie</button>
    </div>

    <h3 style="margin-top:14px">Pozycja</h3>
    <div class="bar">
      <select id="i_kat">
        <option>Rzepak</option><option selected>Kukurydza</option><option>Zbo≈ºa</option><option>Trawy</option><option>Inne</option>
      </select>
      <input id="i_odm" placeholder="Odmiana">
      <input id="i_cena" type="number" step="0.01" placeholder="Cena/szt">
      <input id="i_dos" placeholder="Dostawca (opcjonalnie)">
      <input id="i_qty" type="number" step="1" placeholder="Ilo≈õƒá">
      <button class="btn" id="i_add">Dodaj pozycjƒô</button>
    </div>
  </div>

  <!-- LISTA ZAM√ìWIE≈É -->
  <div class="card" style="margin-top:12px">
    <h2>Zam√≥wienia (ostatnie)</h2>
    <div class="bar">
      <input id="o_search" placeholder="Szukaj: klient/odmiana/uwagi...">
      <button class="btn" id="o_reload">Od≈õwie≈º</button>
    </div>
    <div id="orders"></div>
  </div>

  <!-- RAPORTY -->
  <div class="card" style="margin-top:12px">
    <h2>Raporty i eksport</h2>
    <div class="bar">
      <label>Od <input type="date" id="r_from"></label>
      <label>Do <input type="date" id="r_to"></label>
      <label><input type="checkbox" id="rf_rzepak" checked> Rzepak</label>
      <label><input type="checkbox" id="rf_kuk" checked> Kukurydza</label>
      <label><input type="checkbox" id="rf_zboza" checked> Zbo≈ºa</label>
      <label><input type="checkbox" id="rf_trawy" checked> Trawy</label>
      <label><input type="checkbox" id="rf_inne" checked> Inne</label>
      <button class="btn" id="r_show">Poka≈º zestawienie</button>
      <button class="btn" id="r_export_sum">Pobierz CSV (sumy odmian)</button>
      <button class="btn" id="r_export">Pobierz CSV: pozycje (szczeg√≥≈Çowy)</button>
    </div>

    <h3 style="margin-top:10px">Zestawienie sum odmian (wszyscy klienci)</h3>
    <table class="grid tight" id="sum_tbl">
      <thead>
        <tr>
          <th>Kategoria</th>
          <th>Odmiana</th>
          <th class="right">Zam√≥wiono</th>
          <th class="right">Wydano (sprzedane)</th>
          <th class="right">Pozosta≈Ço</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <th colspan="2" class="right">RAZEM</th>
          <th class="right" id="sum_ord">0</th>
          <th class="right" id="sum_del">0</th>
          <th class="right" id="sum_rem">0</th>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ==== Twoje KLUCZE SUPABASE (ju≈º wstawione) ==== */
const SUPABASE_URL = "https://zseqkyjcqkuvrqxluihs.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzZXFreWpjcWt1dnJxeGx1aWhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNDk2NjUsImV4cCI6MjA3NjkyNTY2NX0.ubbYQzYWiMyETohwKRnVQZaZRoIA-zwiX2YsY8TPsDk";
/* =============================================== */

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const q = (s)=>document.querySelector(s);
const onlineEl = q('#online');

async function ping(){
  try{
    const { error } = await sb.from('seedorders_orders').select('id',{count:'exact',head:true}).limit(1);
    if(error) throw error;
    onlineEl.textContent='online'; onlineEl.style.background='#1f4b36'; onlineEl.style.color='#8de5b9';
  }catch(e){ onlineEl.textContent='offline'; console.error('PING:', e); }
}
ping();

/* Helpers */
function toPL(n){ return (n==null||isNaN(n))?'':Number(n).toFixed(2).replace('.',','); }
function confirmBox(msg){ return window.confirm(msg); }
function setToggle(linkId, sectionId){
  const link=q(linkId), sec=q(sectionId);
  const set=(show)=>{ sec.style.display=show?'':'none'; link.textContent=show?'Ukryj':'Poka≈º'; };
  link.onclick=()=>set(sec.style.display==='none');
  set(true);
}
setToggle('#toggle_prices','#prices_section');
setToggle('#toggle_clients','#clients_section');

/* ===================== CENNIK ===================== */
let editPriceId = null;

function pickedPriceCats(){
  const cats=[];
  if(q('#pf_rzepak').checked) cats.push('Rzepak');
  if(q('#pf_kuk').checked)    cats.push('Kukurydza');
  if(q('#pf_zboza').checked)  cats.push('Zbo≈ºa');
  if(q('#pf_trawy').checked)  cats.push('Trawy');
  if(q('#pf_inne').checked)   cats.push('Inne');
  return cats;
}

async function loadPrices(){
  let req = sb.from('seedorders_prices').select('*').order('odmiana',{ascending:true});
  const cats = pickedPriceCats();
  if(cats.length && cats.length<5) req = req.in('kategoria', cats);
  const { data, error } = await req;
  const tb = q('#price_tbl tbody'); tb.innerHTML='';
  if(error) return alert(error.message);
  data.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${r.odmiana}</td>
      <td>${r.kategoria}</td>
      <td class="right">${toPL(r.cena)}</td>
      <td>${r.dostawca||''}</td>
      <td>
        <button class="btn iconbtn" onclick="editPrice('${r.id}','${encodeURIComponent(r.kategoria)}','${encodeURIComponent(r.odmiana)}','${r.cena}','${encodeURIComponent(r.dostawca||'')}')">‚úèÔ∏è</button>
        <button class="btn iconbtn danger" onclick="delPrice('${r.id}')">üóëÔ∏è</button>
      </td>`;
    tb.appendChild(tr);
  });
}
async function savePrice(){
  const row = {
    odmiana: q('#p_odm').value.trim(),
    kategoria: q('#p_kat').value,
    cena: Number(q('#p_cena').value||0),
    dostawca: q('#p_dos').value.trim()||null
  };
  if(!row.odmiana || !row.kategoria || !row.cena){ alert('Uzupe≈Çnij: odmiana, kategoria, cena'); return; }
  let resp;
  if(editPriceId){ resp = await sb.from('seedorders_prices').update(row).eq('id', editPriceId); }
  else{ resp = await sb.from('seedorders_prices').insert(row); }
  if(resp.error){ alert('B≈ÇƒÖd cennika: '+resp.error.message); return; }
  cancelPriceEdit(); loadPrices();
}
function editPrice(id, kat, odm, cena, dos){
  editPriceId=id;
  q('#p_kat').value=decodeURIComponent(kat);
  q('#p_odm').value=decodeURIComponent(odm);
  q('#p_cena').value=cena;
  q('#p_dos').value=decodeURIComponent(dos);
  q('#p_cancel').style.display='';
}
function cancelPriceEdit(){
  editPriceId=null;
  q('#p_odm').value=''; q('#p_cena').value=''; q('#p_dos').value='';
  q('#p_cancel').style.display='none';
}
async function delPrice(id){
  if(!confirmBox('UsunƒÖƒá pozycjƒô cennika?')) return;
  const { error } = await sb.from('seedorders_prices').delete().eq('id', id);
  if(error) return alert(error.message);
  loadPrices();
}
q('#p_save').onclick=savePrice;
q('#p_cancel').onclick=cancelPriceEdit;
q('#p_refresh').onclick=loadPrices;
['#pf_rzepak','#pf_kuk','#pf_zboza','#pf_trawy','#pf_inne'].forEach(s=>q(s).onchange=loadPrices);
loadPrices();

/* ===================== KLIENCI ===================== */
let editClientId = null;

async function loadClients(filter=''){
  let req= sb.from('seedorders_clients').select('*').order('name',{ascending:true});
  if(filter) req=req.ilike('name', `%${filter}%`);
  const { data, error } = await req;
  if(error) return alert(error.message);
  const tb=q('#cli_tbl tbody'); tb.innerHTML='';
  const sel=q('#o_client'); sel.innerHTML='';
  (data||[]).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${r.name}</td><td>${r.phone||''}</td><td>${r.address||''}</td>
      <td>
        <button class="btn iconbtn" onclick="editClient('${r.id}','${encodeURIComponent(r.name)}','${encodeURIComponent(r.phone||'')}','${encodeURIComponent(r.address||'')}')">‚úèÔ∏è</button>
        <button class="btn iconbtn danger" onclick="delClient('${r.id}')">üóëÔ∏è</button>
      </td>`;
    tb.appendChild(tr);
    const opt=document.createElement('option');
    opt.value=r.id; opt.textContent=`${r.name} ‚Ä¢ ${r.phone||''}`; opt.dataset.phone=r.phone||'';
    sel.appendChild(opt);
  });
  updateClientPhone();
}
function updateClientPhone(){
  const sel=q('#o_client'); const opt=sel.options[sel.selectedIndex];
  q('#o_phone').value=opt? (opt.dataset.phone||'') : '';
}
async function saveClient(){
  const row={ name:q('#c_name').value.trim(), phone:q('#c_phone').value.trim()||null, address:q('#c_addr').value.trim()||null };
  if(!row.name){ alert('Podaj nazwƒô klienta'); return; }
  let resp;
  if(editClientId){ resp=await sb.from('seedorders_clients').update(row).eq('id', editClientId); }
  else{ resp=await sb.from('seedorders_clients').insert(row); }
  if(resp.error){ alert('B≈ÇƒÖd klienta: '+resp.error.message); return; }
  cancelClientEdit(); loadClients(q('#c_filter').value.trim());
}
function editClient(id, name, phone, addr){
  editClientId=id;
  q('#c_name').value=decodeURIComponent(name);
  q('#c_phone').value=decodeURIComponent(phone);
  q('#c_addr').value=decodeURIComponent(addr);
  q('#c_cancel').style.display='';
}
function cancelClientEdit(){
  editClientId=null;
  q('#c_name').value=''; q('#c_phone').value=''; q('#c_addr').value='';
  q('#c_cancel').style.display='none';
}
async function delClient(id){
  if(!confirmBox('UsunƒÖƒá kontrahenta? (zam√≥wienia pozostanƒÖ)')) return;
  const { error } = await sb.from('seedorders_clients').delete().eq('id', id);
  if(error) return alert(error.message);
  loadClients(q('#c_filter').value.trim());
}
q('#c_save').onclick=saveClient;
q('#c_cancel').onclick=cancelClientEdit;
q('#c_refresh').onclick=()=>loadClients(q('#c_filter').value.trim());
q('#o_client').onchange=updateClientPhone;
loadClients();

/* ===================== ZAM√ìWIENIA ===================== */
async function createOrder(){
  const sel=q('#o_client'); if(!sel.value){ alert('Wybierz klienta'); return; }
  const { data:cli } = await sb.from('seedorders_clients').select('name,phone').eq('id', sel.value).single();
  const row={ client_id:sel.value, client:cli?.name||null, phone:cli?.phone||null, notes:q('#o_notes').value.trim()||null };
  const { error } = await sb.from('seedorders_orders').insert(row);
  if(error) return alert('B≈ÇƒÖd tworzenia zam√≥wienia: '+error.message);
  q('#o_notes').value=''; loadOrders();
}
q('#o_add').onclick=createOrder;

async function addItem(){
  const sel=q('#o_client'); if(!sel.value){ alert('Najpierw utw√≥rz nag≈Ç√≥wek zam√≥wienia'); return; }
  const { data:order } = await sb.from('seedorders_orders').select('id').eq('client_id', sel.value).order('created_at',{ascending:false}).limit(1).single();
  if(!order){ alert('Brak nag≈Ç√≥wka ‚Äì kliknij ‚ÄûUtw√≥rz zam√≥wienie‚Äù'); return; }
  const row={
    order_id:order.id,
    kategoria:q('#i_kat').value,
    odmiana:q('#i_odm').value.trim(),
    cena:Number(q('#i_cena').value||0),
    dostawca:q('#i_dos').value.trim()||null,
    ilosc:Number(q('#i_qty').value||0)
  };
  if(!row.odmiana || !row.ilosc){ alert('Podaj odmianƒô i ilo≈õƒá'); return; }
  const { error } = await sb.from('seedorders_items').insert(row);
  if(error) return alert('B≈ÇƒÖd pozycji: '+error.message);
  q('#i_odm').value=''; q('#i_cena').value=''; q('#i_dos').value=''; q('#i_qty').value='';
  loadOrders();
}
q('#i_add').onclick=addItem;

function statusClass(rem, ord){ if(rem===0 && ord>0) return 'k-done'; if(rem>0 && rem<ord) return 'k-part'; return 'k-new'; }
function statusBadge(rem, ord){ if(rem===0 && ord>0) return '<span class="status s-done">dostarczone</span>'; if(rem>0 && rem<ord) return '<span class="status s-part">czƒô≈õciowo</span>'; return '<span class="status s-new">zam√≥wione</span>'; }

async function loadOrders(){
  const search=q('#o_search').value.trim().toLowerCase();
  const { data:orders } = await sb.from('seedorders_orders').select('id,client,phone,notes,created_at').order('created_at',{ascending:false}).limit(200);
  const container=q('#orders'); container.innerHTML='';

  const ids = (orders||[]).map(o=>o.id);
  let itemsByOrder={};
  if(ids.length){
    const { data:allItems } = await sb.from('seedorders_items')
      .select('id,order_id,odmiana,kategoria,cena,ilosc,wydano,remaining_qty,ordered_qty,delivered_qty')
      .in('order_id', ids).order('created_at',{ascending:true});
    (allItems||[]).forEach(x=>{ (itemsByOrder[x.order_id] ||= []).push(x); });
  }

  orders.sort((a,b)=>{
    const A=(itemsByOrder[a.id]||[]).reduce((s,x)=>s+Number(x.remaining_qty||0),0)===0?1:0;
    const B=(itemsByOrder[b.id]||[]).reduce((s,x)=>s+Number(x.remaining_qty||0),0)===0?1:0;
    return A-B || (new Date(b.created_at)-new Date(a.created_at));
  });

  for(const o of (orders||[])){
    const items=itemsByOrder[o.id]||[];
    const ord=items.reduce((a,x)=>a+Number(x.ordered_qty??x.ilosc??0),0);
    const rem=items.reduce((a,x)=>a+Number(x.remaining_qty ?? Math.max((x.ordered_qty??x.ilosc||0)-(x.delivered_qty??x.wydano||0),0)),0);
    const klass=statusClass(rem,ord), badge=statusBadge(rem,ord);

    const card=document.createElement('div'); card.className='card '+klass;
    card.innerHTML=`
      <div class="bar" style="justify-content:space-between">
        <div><strong>${o.client||'‚Äî'}</strong> ‚Ä¢ ${o.phone||''}
          &nbsp;<span class="pill">${new Date(o.created_at).toISOString().slice(0,10)}</span>
          &nbsp; ${badge}
        </div>
        <div class="muted">${o.notes||''}</div>
      </div>
      <table class="grid"><thead><tr><th>Odmiana</th><th>Zam√≥wiono</th><th>Wydano</th><th>Pozosta≈Ço</th><th>Wydaj</th></tr></thead>
      <tbody>${items.map(x=>{
        const ordered=Number(x.ordered_qty??x.ilosc??0);
        const delivered=Number(x.delivered_qty??x.wydano??0);
        const left=Number(x.remaining_qty ?? Math.max(ordered-delivered,0));
        return `<tr>
          <td>${x.kategoria} ‚Ä¢ ${x.odmiana}</td>
          <td>${ordered}</td>
          <td>${delivered}</td>
          <td>${left}</td>
          <td><div class="bar">
            <input type="number" step="1" min="0" value="1" id="give_${x.id}">
            <button class="btn" onclick="give('${x.id}')">OK</button>
          </div></td>
        </tr>`;}).join('')}</tbody></table>`;
    const text=(card.textContent||'').toLowerCase();
    if(!search || text.includes(search)) container.appendChild(card);
  }
}
q('#o_reload').onclick=loadOrders;
q('#o_search').oninput=()=>loadOrders();
loadOrders();

window.give = async function(itemId){
  const inp=q('#give_'+itemId); const qty=Number(inp.value||0); if(qty<=0) return;
  const { data:item, error } = await sb.from('seedorders_items').select('delivered_qty,wydano').eq('id',itemId).single();
  if(error) return alert(error.message);
  const curr=Number(item.delivered_qty ?? item.wydano ?? 0);
  const { error:errU } = await sb.from('seedorders_items').update({delivered_qty:curr+qty}).eq('id',itemId);
  if(errU) return alert(errU.message);
  loadOrders();
};

/* ===================== RAPORTY ===================== */
function csvRow(arr){ return arr.map(v=>{ if(v==null) return ''; const s=String(v).replace(/"/g,'""'); return /[",;\n]/.test(s)?`"${s}"`:s; }).join(';'); }
function download(name, text){ const blob=new Blob([text],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500); }

function pickedReportCats(){
  const cats=[];
  if(q('#rf_rzepak').checked) cats.push('Rzepak');
  if(q('#rf_kuk').checked)    cats.push('Kukurydza');
  if(q('#rf_zboza').checked)  cats.push('Zbo≈ºa');
  if(q('#rf_trawy').checked)  cats.push('Trawy');
  if(q('#rf_inne').checked)   cats.push('Inne');
  return cats;
}

async function exportCSV(){ // szczeg√≥≈Çowy (pozycje)
  const from=q('#r_from').value||'1970-01-01';
  const to=q('#r_to').value||'2999-12-31';
  const cats=pickedReportCats();
  const { data:orders } = await sb.from('seedorders_orders')
    .select('id,client,phone,notes,created_at')
    .gte('created_at',from).lte('created_at',to+'T23:59:59').order('created_at',{ascending:true});
  const ids=(orders||[]).map(o=>o.id);
  let items=[];
  if(ids.length){
    let req=sb.from('seedorders_items')
      .select('order_id,kategoria,odmiana,cena,dostawca,ordered_qty,delivered_qty,remaining_qty,ilosc,wydano')
      .in('order_id', ids);
    if(cats.length && cats.length<5) req=req.in('kategoria', cats);
    const { data:it } = await req;
    items=it||[];
  }
  const lookup=Object.fromEntries((orders||[]).map(o=>[o.id,o]));
  const header=['Data','Klient','Telefon','Kategoria','Odmiana','Zam√≥wiono','Wydano','Pozosta≈Ço','Cena','Dostawca','Uwagi'];
  let rows=[csvRow(header)];
  items.forEach(x=>{
    const o=lookup[x.order_id];
    const ord=Number(x.ordered_qty??x.ilosc??0);
    const del=Number(x.delivered_qty??x.wydano??0);
    const rem=Number(x.remaining_qty ?? Math.max(ord-del,0));
    rows.push(csvRow([
      new Date(o.created_at).toISOString().slice(0,10),
      o.client||'', o.phone||'', x.kategoria||'', x.odmiana||'',
      ord, del, rem, toPL(x.cena), x.dostawca||'', o.notes||''
    ]));
  });
  download(`raport_pozycje_${from}_${to}.csv`, rows.join('\n'));
}

async function loadSummary(){
  const from=q('#r_from').value||'1970-01-01';
  const to=q('#r_to').value||'2999-12-31';
  const cats=pickedReportCats();

  const { data:orders, error:eo } = await sb.from('seedorders_orders')
    .select('id').gte('created_at',from).lte('created_at',to+'T23:59:59');
  if(eo) return alert(eo.message);
  const ids=(orders||[]).map(o=>o.id);
  const tb=q('#sum_tbl tbody'); tb.innerHTML='';
  if(!ids.length){ q('#sum_ord').textContent='0'; q('#sum_del').textContent='0'; q('#sum_rem').textContent='0'; return; }

  let req=sb.from('seedorders_items')
    .select('kategoria,odmiana,ordered_qty,delivered_qty,remaining_qty,ilosc,wydano')
    .in('order_id', ids);
  if(cats.length && cats.length<5) req=req.in('kategoria', cats);
  const { data:items, error:ei } = await req;
  if(ei) return alert(ei.message);

  const map=new Map();
  for(const x of (items||[])){
    const kat=x.kategoria||'‚Äî', odm=x.odmiana||'‚Äî';
    const key=kat+'|'+odm;
    const ord=Number(x.ordered_qty??x.ilosc??0);
    const del=Number(x.delivered_qty??x.wydano??0);
    const rem=Number(x.remaining_qty ?? Math.max(ord-del,0));
    const agg=map.get(key)||{kategoria:kat,odmiana:odm,zam:0,wyd:0,poz:0};
    agg.zam+=ord; agg.wyd+=del; agg.poz+=rem; map.set(key,agg);
  }
  const rows=Array.from(map.values()).sort((a,b)=> (a.kategoria||'').localeCompare(b.kategoria||'') || (a.odmiana||'').localeCompare(b.odmiana||''));
  let sumOrd=0,sumDel=0,sumRem=0;
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.kategoria}</td><td>${r.odmiana}</td><td class="right">${r.zam}</td><td class="right">${r.wyd}</td><td class="right">${r.poz}</td>`;
    tb.appendChild(tr);
    sumOrd+=r.zam; sumDel+=r.wyd; sumRem+=r.poz;
  });
  q('#sum_ord').textContent=sumOrd; q('#sum_del').textContent=sumDel; q('#sum_rem').textContent=sumRem;
}
function exportSummaryCSV(){
  const from=q('#r_from').value||'1970-01-01';
  const to=q('#r_to').value||'2999-12-31';
  const tb=q('#sum_tbl tbody');
  const lines=[csvRow(['Kategoria','Odmiana','Zam√≥wiono','Wydano','Pozosta≈Ço'])];
  Array.from(tb.querySelectorAll('tr')).forEach(tr=>{
    const t=tr.querySelectorAll('td'); if(t.length===5) lines.push(csvRow([t[0].textContent,t[1].textContent,t[2].textContent,t[3].textContent,t[4].textContent]));
  });
  lines.push(csvRow(['RAZEM','',q('#sum_ord').textContent,q('#sum_del').textContent,q('#sum_rem').textContent]));
  download(`raport_sumy_odmian_${from}_${to}.csv`, lines.join('\n'));
}
q('#r_export').onclick=exportCSV;
q('#r_export_sum').onclick=exportSummaryCSV;
q('#r_show').onclick=loadSummary;
['#rf_rzepak','#rf_kuk','#rf_zboza','#rf_trawy','#rf_inne'].forEach(s=>q(s).onchange=loadSummary);

// domy≈õlnie ‚Äì bie≈ºƒÖcy rok i od razu policz
(function initReportDates(){
  const now=new Date(), y=now.getFullYear();
  q('#r_from').value=`${y}-01-01`; q('#r_to').value=`${y}-12-31`; loadSummary();
})();
</script>
</body>
</html>
