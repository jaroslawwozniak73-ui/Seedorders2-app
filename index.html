<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SeedOrders — wspólna baza</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#111936; --muted:#99a6c0; --text:#e9f0ff;
      --accent:#36d399; --accent2:#60a5fa; --danger:#ef4444; --line:#2a345a;
      --ghost:#1a2344;
    }
    *{box-sizing:border-box}
    body{margin:0;font:15px/1.4 ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg)}
    .wrap{max-width:1200px;margin:auto;padding:16px;display:grid;gap:16px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
    .row{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .grid{display:grid;gap:10px}
    .flex{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    input,select,button,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0e1530;color:var(--text)}
    textarea{min-height:70px}
    button{cursor:pointer;background:var(--accent);border:0;color:#0b1020;font-weight:600}
    button.ghost{background:var(--ghost);color:var(--text)}
    button.warn{background:var(--danger);color:#fff}
    .btn-sm{padding:6px 10px;border-radius:9px;font-size:13px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid var(--line);vertical-align:top}
    .chip{display:inline-flex;align-items:center;padding:3px 9px;border-radius:999px;border:1px solid var(--line);background:#0e1530}
    .ok{color:#7fffd4}
    .bad{color:#ffb4b4}
    .right{text-align:right}
    .grow{flex:1}
  </style>
</head>
<body>
<div class="wrap">

  <div class="flex">
    <h1 class="grow">SeedOrders — wspólna baza</h1>
    <span class="chip" id="status">offline</span>
    <span class="chip" id="clock"></span>
    <button id="refreshAll" class="ghost">Odśwież wszystko</button>
  </div>

  <!-- Cennik -->
  <div class="panel">
    <div class="flex">
      <h2 class="grow">Cennik (seedorders_prices)</h2>
      <button id="togglePrices" class="ghost btn-sm">Ukryj</button>
    </div>

    <div id="pricesBody" class="grid">
      <div class="row">
        <select id="pCategory">
          <option value="Rzepak">Rzepak</option>
          <option value="Kukurydza">Kukurydza</option>
          <option value="Zboża">Zboża</option>
          <option value="Trawy">Trawy</option>
          <option value="Inne">Inne</option>
        </select>
        <input id="pVar" placeholder="Odmiana" />
        <input id="pPrice" type="number" step="0.01" placeholder="Cena / szt." />
        <input id="pVendor" placeholder="Dostawca (opcjonalnie)" />
      </div>
      <div class="flex">
        <button id="pSave" class="btn-sm">Zapisz</button>
        <input id="pSearch" class="grow" placeholder="Szukaj w cenniku…" />
      </div>
      <table>
        <thead>
          <tr><th>Odmiana</th><th>Kategoria</th><th class="right">Cena</th><th>Dostawca</th><th></th></tr>
        </thead>
        <tbody id="pricesT"></tbody>
      </table>
    </div>
  </div>

  <!-- Kontrahenci -->
  <div class="panel">
    <div class="flex">
      <h2 class="grow">Kontrahenci (seedorders_clients)</h2>
      <button id="toggleClients" class="ghost btn-sm">Ukryj</button>
    </div>
    <div id="clientsBody" class="grid">
      <div class="row">
        <input id="cName" placeholder="Nazwa (np. Jan Kowalski)" />
        <input id="cPhone" placeholder="Telefon" />
      </div>
      <div class="row">
        <input id="cAddr" placeholder="Adres (ulica, kod, miejscowość, kraj)" />
        <div class="flex">
          <button id="cSave" class="btn-sm">Zapisz</button>
          <button id="cDelete" class="btn-sm warn">Usuń</button>
          <input id="cSearch" class="grow" placeholder="Szukaj klienta…" />
          <button id="cRefresh" class="btn-sm ghost">Odśwież listę</button>
        </div>
      </div>
      <table>
        <thead><tr><th>Nazwa</th><th>Telefon</th><th>Adres</th></tr></thead>
        <tbody id="clientsT"></tbody>
      </table>
    </div>
  </div>

  <!-- Dodaj zamówienie -->
  <div class="panel">
    <h2>Dodaj zamówienie</h2>
    <div class="row">
      <select id="oClient"></select>
      <input id="oPhone" placeholder="Telefon (auto)" />
      <select id="oCategory">
        <option>Rzepak</option><option>Kukurydza</option><option>Zboża</option>
        <option>Trawy</option><option>Inne</option>
      </select>
      <select id="oVar"></select>
      <input id="oQty" type="number" min="1" value="1" />
      <input id="oPrice" type="number" step="0.01" placeholder="Cena / szt." />
      <input id="oVendor" placeholder="Dostawca (opcjonalnie)" />
      <input id="oNotes" class="grow" placeholder="Uwagi (opcjonalnie)" />
      <button id="addItem" class="primary">Dodaj pozycję</button>
    </div>
  </div>

  <!-- Zamówienia -->
  <div class="panel">
    <div class="flex">
      <h2 class="grow">Zamówienia (ostatnie)</h2>
    </div>
    <input id="oSearch" class="srch" placeholder="Szukaj: klient/odmiana/uwagi…" />
    <select id="oStatusFilter">
      <option value="">Wszystkie statusy</option>
      <option value="zamówione">zamówione</option>
      <option value="częściowo">częściowo</option>
      <option value="dostarczone">dostarczone</option>
    </select>

    <button id="oReload" class="ghost">Odśwież</button>

    <div class="flex" style="gap:8px;align-items:center;margin:8px 0;">
      <button id="exportClientsCSV" class="ghost btn-sm">Eksport: klient → odmiany (CSV)</button>
      <span class="small muted">NIEODEBRANE (suma braków): <span id="notPickedSummary"></span></span>
    </div>

    <div id="ordersContainer"></div>
  </div>

  <!-- Raport -->
  <div class="panel grid">
    <div class="flex"><h2>Raport</h2></div>
    <div class="row">
      <input id="rFrom" type="date" />
      <input id="rTo" type="date" />
      <select id="rCat">
        <option value="">(wszystkie)</option>
        <option value="Rzepak">Rzepak</option>
        <option value="Kukurydza">Kukurydza</option>
        <option value="Zboża">Zboża</option>
        <option value="Trawy">Trawy</option>
        <option value="Inne">Inne</option>
      </select>
      <button id="rShow" class="ghost">Pokaż</button>
      <button id="rCSV" class="ghost">CSV</button>
    </div>
    <table>
      <thead><tr><th>Kategoria</th><th>Odmiana</th><th class="right">Zam.</th><th class="right">Wyd.</th></tr></thead>
      <tbody id="reportT"></tbody>
    </table>
    <div class="small muted">Zakres: <span id="rRange"></span></div>
  </div>

</div>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

<script>
/* ====== KONFIGURACJA SUPABASE (Twoje klucze) ====== */
const SUPABASE_URL  = 'https://zseqkyjcqkuvrqxluihs.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzZXFreWpjcWt1dnJxeGx1aWhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNDk2NjUsImV4cCI6MjA3NjkyNTY2NX0.ubbYQzYWiMyETohwKRnVQZaZRoIA-zwiX2YsY8TPsDk';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{ persistSession:false }});

/* ====== POMOCNICZE ====== */
const $  = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const fmt = n => (n??0).toLocaleString('pl-PL');
const nowISO = () => new Date().toISOString().slice(0,10);
let orders = []; // cache aktualnie wyświetlanych nagłówków

// zegar
setInterval(()=>{ const el=$('#clock'); if(el) el.textContent = new Date().toLocaleTimeString('pl-PL'); }, 1000);

/* ====== STATUS ====== */
async function setStatus(){
  try{
    const { error } = await db.from('seedorders_prices').select('id').limit(1);
    const el = $('#status');
    if(error){ el.textContent='offline'; el.className='chip bad'; }
    else { el.textContent='online'; el.className='chip ok'; }
  }catch{ const el=$('#status'); el.textContent='offline'; el.className='chip bad'; }
}

/* ====== CENNIK ====== */
async function loadPrices(){
  const q = ($('#pSearch').value||'').toLowerCase();
  const { data, error } = await db.from('seedorders_prices').select('*').order('kategoria').order('odmiana');
  if(error) return alert('Błąd cennika: '+error.message);
  const tbody = $('#pricesT'); tbody.innerHTML='';
  (data||[]).filter(r=>{
    const s = `${r.odmiana||''} ${r.kategoria||''} ${r.dostawca||''}`.toLowerCase();
    return s.includes(q);
  }).forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.odmiana||''}</td>
      <td>${r.kategoria||''}</td>
      <td class="right">${r.cena!=null? fmt(r.cena):''}</td>
      <td>${r.dostawca||''}</td>
      <td class="right"><button class="btn-sm warn" data-delprice="${r.id}">Usuń</button></td>
    `;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('[data-delprice]').forEach(b=> b.onclick=()=>deletePrice(b.dataset.delprice));
}
async function savePrice(){
  const row = {
    kategoria: $('#pCategory').value||'',
    odmiana:   $('#pVar').value||'',
    cena:      $('#pPrice').value ? Number($('#pPrice').value) : null,
    dostawca:  $('#pVendor').value||null
  };
  if(!row.odmiana){ alert('Podaj odmianę'); return; }
  const { error } = await db.from('seedorders_prices').upsert(row);
  if(error) alert('Błąd zapisu cennika: '+error.message);
  await loadPrices();
}
async function deletePrice(id){
  if(!confirm('Usunąć pozycję z cennika?')) return;
  const { error } = await db.from('seedorders_prices').delete().eq('id', id);
  if(error) alert('Błąd usuwania: '+error.message);
  await loadPrices();
}

/* ====== KONTRAHENCI ====== */
async function loadClients(){
  const q = ($('#cSearch').value||'').toLowerCase();
  const { data, error } = await db.from('seedorders_clients').select('*').order('name');
  if(error) return alert('Błąd klientów: '+error.message);
  const tbody = $('#clientsT'); tbody.innerHTML='';
  const combo = $('#oClient'); combo.innerHTML='';
  (data||[]).forEach(c=>{
    const ok = `${c.name||''} ${c.phone||''} ${c.address||''}`.toLowerCase().includes(q);
    if(ok){
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${c.name||''}</td><td>${c.phone||''}</td><td>${c.address||''}</td>`;
      tbody.appendChild(tr);
    }
    const opt = document.createElement('option');
    opt.value = c.id; opt.textContent = c.name||'(bez nazwy)';
    combo.appendChild(opt);
  });
}
async function saveClient(){
  const row = { name:$('#cName').value||'', phone:$('#cPhone').value||'', address:$('#cAddr').value||'' };
  if(!row.name){ alert('Podaj nazwę'); return; }
  const { error } = await db.from('seedorders_clients').upsert(row);
  if(error) alert('Błąd zapisu klienta: '+error.message);
  await loadClients();
}
async function deleteClient(){
  const name = $('#cName').value||'';
  if(!name){ alert('Podaj nazwę (klucz) do usunięcia'); return; }
  if(!confirm(`Usunąć klienta: ${name}?`)) return;
  const { error } = await db.from('seedorders_clients').delete().eq('name', name);
  if(error) alert('Błąd usuwania klienta: '+error.message);
  await loadClients();
}

/* ====== LISTA ODMIAN wg kategorii (do formularza) ====== */
async function fillOdmianyFor(cat){
  $('#oVar').innerHTML='';
  const { data, error } = await db.from('seedorders_prices').select('odmiana').eq('kategoria', cat).order('odmiana');
  if(error) return;
  (data||[]).forEach(r=>{
    const opt=document.createElement('option'); opt.textContent=r.odmiana; opt.value=r.odmiana;
    $('#oVar').appendChild(opt);
  });
}

/* ====== ZAMÓWIENIA (nagłówek + pozycja) ====== */
async function addOrderItem(){
  const client_id = $('#oClient').value;
  if(!client_id){ alert('Wybierz klienta'); return; }
  const { data:cli } = await db.from('seedorders_clients').select('*').eq('id', client_id).single();

  // nagłówek
  const head = {
    client: cli?.name || '(client)',
    phone:  cli?.phone || '',
    notes:  $('#oNotes').value || null,
    created_at: new Date().toISOString()
  };
  const { data:o, error:eH } = await db.from('seedorders_orders').insert(head).select().single();
  if(eH){ alert('Błąd nagłówka: '+eH.message); return; }

  // pozycja
  const qty = Number($('#oQty').value||0);
  const price = $('#oPrice').value ? Number($('#oPrice').value) : null;
  const item = {
    order_id:o.id,
    kategoria: $('#oCategory').value,
    odmiana:   $('#oVar').value,
    ordered_qty: qty, ilosc: qty,
    delivered_qty: 0, wydano: 0,
    cena: price,
    dostawca: $('#oVendor').value||null
  };
  const { error:e2 } = await db.from('seedorders_items').insert(item);
  if(e2) alert('Błąd dodawania pozycji: '+e2.message);

  await loadOrders();
  await loadReport();
}

/* ====== EDYCJA POZYCJI (ilość i cena) ====== */
async function editOrderItem(itemId, orderId){
  const { data, error } = await db.from('seedorders_items')
    .select('id, kategoria, odmiana, cena, ordered_qty, ilosc, delivered_qty, wydano')
    .eq('id', itemId).single();
  if(error){ alert('Błąd odczytu pozycji: '+error.message); return; }

  const curQty   = data.ordered_qty ?? data.ilosc ?? 0;
  const curPrice = (data.cena ?? null);

  const nextQtyStr   = prompt(`Nowa ilość dla ${data.kategoria||''} / ${data.odmiana||''}:`, String(curQty));
  if(nextQtyStr===null) return;
  const nextQty = Math.max(0, Number(nextQtyStr)||0);

  const nextPriceStr = prompt('Nowa cena za szt. (puste = bez zmian):', curPrice!==null ? String(curPrice) : '');
  let nextPrice = (nextPriceStr===null || nextPriceStr.trim()==='') ? curPrice : Number(nextPriceStr);
  if(Number.isNaN(nextPrice)) nextPrice = curPrice;

  const upd = { ordered_qty: nextQty, ilosc: nextQty };
  if(nextPrice !== null) upd.cena = nextPrice;

  const { error:errU } = await db.from('seedorders_items').update(upd).eq('id', itemId);
  if(errU){ alert('Błąd zapisu: '+errU.message); return; }

  await updateOrderStatusByItems(orderId);
  await loadOrders();
  await loadReport();
}

/* ====== STATUS nagłówka po pozycjach ====== */
async function updateOrderStatusByItems(orderId){
  const { data:items, error } = await db.from('seedorders_items')
    .select('ordered_qty, ilosc, delivered_qty, wydano').eq('order_id', orderId);
  if(error) return;
  let sumOrd=0, sumDel=0;
  for(const it of (items||[])){
    const o = it.ordered_qty ?? it.ilosc ?? 0;
    const d = it.delivered_qty ?? it.wydano ?? 0;
    sumOrd += Number(o||0); sumDel += Number(d||0);
  }
  const status = (sumDel<=0) ? 'zamówione' : (sumDel<sumOrd ? 'częściowo' : 'dostarczone');
  await db.from('seedorders_orders').update({ status }).eq('id', orderId);
}

/* ====== RENDER ZAMÓWIEŃ ====== */
async function loadOrders(){
  const { data:heads, error } = await db.from('seedorders_orders')
    .select('*').order('created_at', { ascending:false }).limit(200);
  if(error){ alert('Błąd zamówień: '+error.message); return; }
  orders = heads||[];

  const ids = orders.map(o=>o.id);
  const { data:items } = ids.length
    ? await db.from('seedorders_items').select('*').in('order_id', ids)
    : { data: [] };

  const byOrder = new Map();
  (items||[]).forEach(it=>{
    if(!byOrder.has(it.order_id)) byOrder.set(it.order_id, []);
    byOrder.get(it.order_id).push(it);
  });

  renderOrders(orders, byOrder);
}

function renderOrders(heads, itemsByOrder){
  const q = ($('#oSearch').value||'').toLowerCase();
  const only = $('#oStatusFilter').value;
  const box = $('#ordersContainer'); box.innerHTML='';

  // sort: zamówione -> częściowo -> dostarczone (na dół)
  const rank = s => (s==='dostarczone') ? 2 : (s==='częściowo' ? 1 : 0);
  const sorted = heads.slice().sort((a,b)=>{
    const r = rank(a.status||'') - rank(b.status||'');
    if(r!==0) return r;
    return new Date(b.created_at) - new Date(a.created_at);
  });

  const collectedForSummary = [];

  for(const o of sorted){
    if(only && (o.status||'')!==only) continue;
    const items = itemsByOrder.get(o.id)||[];

    const text = `${o.client||''} ${o.phone||''} ${o.notes||''} ${items.map(i=>`${i.kategoria} ${i.odmiana}`).join(' ')}`.toLowerCase();
    if(q && !text.includes(q)) continue;

    const card = document.createElement('div');
    card.className='panel';
    card.innerHTML = `
      <div class="flex">
        <div class="grow"><b>${o.client||''}</b> <span class="muted">(${o.phone||''})</span><br>
          <span class="small muted">${(o.created_at||'').slice(0,10)} · ${o.notes||''}</span>
        </div>
        <span class="chip">${o.status||'zamówione'}</span>
        <button class="ghost btn-sm" data-recalc="${o.id}">Przelicz status</button>
      </div>
      <table class="small">
        <thead><tr><th>Kategoria</th><th>Odmiana</th><th class="right">Zam.</th><th class="right">Wyd.</th><th class="right">Cena</th><th class="right">Brutto</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    `;
    const tbody = card.querySelector('tbody');

    items.forEach(it=>{
      const ord = Number((it.ordered_qty ?? it.ilosc) || 0);
      const del = Number((it.delivered_qty ?? it.wydano) || 0);
      const price = it.cena ?? null;
      const brutto = (price!=null) ? Number(price)*ord : '';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${it.kategoria||''}</td>
        <td>${it.odmiana||''}</td>
        <td class="right">${fmt(ord)}</td>
        <td class="right">${fmt(del)}</td>
        <td class="right">${price!=null ? fmt(price) : ''}</td>
        <td class="right">${brutto!=='' ? fmt(brutto) : ''}</td>
        <td class="right">
          <div class="flex" style="gap:6px;justify-content:flex-end">
            <button class="btn-sm ghost" data-edit="${it.id}" data-order="${o.id}">Edytuj</button>
            <button class="btn-sm warn"  data-delete="${it.id}" data-order="${o.id}">Usuń</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });

    card.querySelectorAll('[data-delete]').forEach(b=> b.onclick=()=>deleteItem(b.dataset.delete, b.dataset.order));
    card.querySelectorAll('[data-edit]').forEach(b=> b.onclick=()=>editOrderItem(b.dataset.edit, b.dataset.order));
    card.querySelector('[button],[data-recalc]')?.addEventListener('click', ()=>updateOrderStatusByItems(o.id));

    items.forEach(it=> collectedForSummary.push({
      kategoria: it.kategoria, odmiana: it.odmiana,
      ordered: (it.ordered_qty ?? it.ilosc) || 0,
      delivered: (it.delivered_qty ?? it.wydano) || 0
    }));

    box.appendChild(card);
  }

  updateNotPickedSummary(collectedForSummary);
}

async function deleteItem(id, orderId){
  if(!confirm('Usunąć pozycję?')) return;
  const { error } = await db.from('seedorders_items').delete().eq('id', id);
  if(error) alert('Błąd usuwania pozycji: '+error.message);
  await updateOrderStatusByItems(orderId);
  await loadOrders();
  await loadReport();
}

/* ====== PODSUMOWANIE BRAKÓW ====== */
function updateNotPickedSummary(collected){
  const agg = new Map();
  for(const it of collected){
    const brak = Math.max(0, Number(it.ordered||0) - Number(it.delivered||0));
    if(brak<=0) continue;
    const key = `${it.kategoria}||${it.odmiana}`;
    agg.set(key, (agg.get(key)||0) + brak);
  }
  const parts=[];
  for(const [key,val] of agg.entries()){
    const [k,o] = key.split('||');
    parts.push(`${k} — ${o}: ${val}`);
  }
  const el = $('#notPickedSummary');
  if(el) el.textContent = parts.length ? parts.join(' | ') : 'brak';
}

/* ====== RAPORT ====== */
function setDefaultReportRange(){
  const d = new Date(); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0');
  $('#rFrom').value = `${y}-${m}-01`;
  $('#rTo').value   = nowISO();
  $('#rRange').textContent = `${$('#rFrom').value} → ${$('#rTo').value}`;
}
async function loadReport(){
  const from = $('#rFrom').value || '2000-01-01';
  const to   = $('#rTo').value   || '2100-01-01';
  const cat  = $('#rCat').value;

  let q = db.from('seedorders_items')
    .select('odmiana, kategoria, ordered_qty, delivered_qty, created_at, ilosc, wydano')
    .gte('created_at', from).lte('created_at', to);

  if(cat) q = q.eq('kategoria', cat);
  const { data, error } = await q;
  if(error){ alert('Błąd raportu: '+error.message); return; }

  const sums = {};
  (data||[]).forEach(r=>{
    const key = `${r.kategoria}||${r.odmiana}`;
    if(!sums[key]) sums[key]={kat:r.kategoria, odm:r.odmiana, zam:0, wyd:0};
    sums[key].zam += Number((r.ordered_qty ?? r.ilosc) || 0);
    sums[key].wyd += Number((r.delivered_qty ?? r.wydano) || 0);
  });

  const tbody = $('#reportT'); tbody.innerHTML='';
  Object.values(sums).forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${s.kat}</td><td>${s.odm}</td><td class="right">${fmt(s.zam)}</td><td class="right">${fmt(s.wyd)}</td>`;
    tbody.appendChild(tr);
  });
  $('#rRange').textContent = `${from} → ${to}`;
}
function downloadCSV(){
  const rows = [...$('#reportT').querySelectorAll('tr')].map(tr=>[...tr.children].map(td=>td.textContent));
  const headers = ['kategoria','odmiana','zamówione','wydane'];
  const csv = [headers, ...rows].map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`raport_${nowISO()}.csv`; a.click();
}

/* ====== EKSPORT: klient → odmiany ====== */
function toCSV(rows, headers){
  return [headers, ...rows].map(r => r.map(v => String(v ?? '').replaceAll('"','""')).join(',')).join('\n');
}
async function exportClientsCSV(){
  const ids = (orders||[]).map(o=>o.id);
  if(!ids.length){ alert('Brak danych do eksportu.'); return; }

  const { data:items, error:e1 } = await db.from('seedorders_items')
    .select('order_id, kategoria, odmiana, cena, ordered_qty, ilosc, delivered_qty, wydano, created_at')
    .in('order_id', ids);
  if(e1){ alert('Błąd pozycji: '+e1.message); return; }

  const index = new Map(orders.map(o=>[o.id,{client:o.client, phone:o.phone, date:o.created_at}]));
  const rows = (items||[]).map(it=>{
    const h=index.get(it.order_id)||{};
    const ord = it.ordered_qty ?? it.ilosc ?? 0;
    const del = it.delivered_qty ?? it.wydano ?? 0;
    const brak = Math.max(0, ord-del);
    const price = it.cena ?? '';
    const brutto = price!=='' ? Number(price)*Number(ord||0) : '';
    return [
      (h.date||'').slice(0,10), h.client||'', h.phone||'',
      it.kategoria||'', it.odmiana||'',
      String(ord), String(del), String(brak),
      String(price), String(brutto)
    ];
  });

  const headers = ['data_zam','klient','telefon','kategoria','odmiana','zamówione','wydane','brak','cena_szt','wartość_brutto'];
  const csv = toCSV(rows, headers);
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`klient_odmiany_${nowISO()}.csv`; a.click();
}

/* ====== START ====== */
(async()=>{
  setDefaultReportRange();
  await setStatus();
  await loadPrices();
  await loadClients();
  await fillOdmianyFor($('#oCategory').value);
  await loadOrders();
  await loadReport();
})();

/* ====== ZDARZENIA UI ====== */
$('#refreshAll') .addEventListener('click', async ()=>{ await setStatus(); await loadPrices(); await loadClients(); await loadOrders(); await loadReport(); });

$('#togglePrices').addEventListener('click', (e)=>{ const b=$('#pricesBody'); const btn=e.target; const hide=b.style.display==='none'; b.style.display=hide?'grid':'none'; btn.textContent=hide?'Ukryj':'Pokaż'; });
$('#toggleClients').addEventListener('click',(e)=>{ const b=$('#clientsBody'); const btn=e.target; const hide=b.style.display==='none'; b.style.display=hide?'grid':'none'; btn.textContent=hide?'Ukryj':'Pokaż'; });

$('#pSave')  .addEventListener('click',  savePrice);
$('#pDelete')?.addEventListener('click', deletePrice);
$('#pSearch').addEventListener('input', loadPrices);
$('#pCategory').addEventListener('change', loadPrices);

$('#cSave').addEventListener('click',  saveClient);
$('#cDelete').addEventListener('click', deleteClient);
$('#cSearch').addEventListener('input', loadClients);
$('#cRefresh').addEventListener('click', loadClients);

$('#oCategory').addEventListener('change', ()=>fillOdmianyFor($('#oCategory').value));
$('#addItem').addEventListener('click', addOrderItem);
$('#oSearch').addEventListener('input', loadOrders);
$('#oStatusFilter').addEventListener('change', loadOrders);
$('#oReload').addEventListener('click', loadOrders);

$('#rShow').addEventListener('click', loadReport);
$('#rCSV').addEventListener('click', downloadCSV);

$('#exportClientsCSV')?.addEventListener('click', exportClientsCSV);
</script>
</body>
</html>
