<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SeedOrders ‚Äî wsp√≥lna baza</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#121936; --muted:#95a0c0; --text:#e8eefc; --accent:#36d399; --accent2:#60a5fa;
      --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444; --chip:#1f2a4a; --line:#2a345a;
    }
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.4 ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg)}
    h1,h2{margin:0 0 .5rem}
    h1{font-size:20px}
    h2{font-size:16px;color:var(--muted)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px;display:grid;gap:16px}
    .grid{display:grid;gap:12px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,select,button,textarea{background:#0e1430;border:1px solid var(--line);color:var(--text);padding:10px;border-radius:10px;outline:none}
    input::placeholder,textarea::placeholder{color:#7481a8}
    button{background:#1b2345;cursor:pointer}
    button.primary{background:var(--accent);color:#042016;font-weight:600;border:0}
    button.warn{background:var(--warn);color:#1a1000;border:0}
    button.danger{background:var(--danger);color:#2b0b0b;border:0}
    button.ghost{background:#101735}
    .btn-sm{padding:6px 10px;border-radius:8px;font-size:12px}
    .right{margin-left:auto}
    .tag{background:var(--chip);padding:4px 8px;border-radius:999px;color:var(--muted);font-size:12px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--line);padding:8px 10px;text-align:left}
    .muted{color:var(--muted)}
    .success{color:var(--ok)}
    .status{font-weight:700;padding:2px 8px;border-radius:999px}
    .sok{background:rgba(22,163,74,.15);color:#7cf2a2;border:1px solid rgba(22,163,74,.3)}
    .swarn{background:rgba(245,158,11,.15);color:#ffd48a;border:1px solid rgba(245,158,11,.3)}
    .sdanger{background:rgba(239,68,68,.15);color:#ff9a9a;border:1px solid rgba(239,68,68,.3)}
    .order{border:1px solid var(--line);border-radius:12px;margin:8px 0}
    .order-header{display:flex;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px dashed var(--line)}
    .order-body{padding:8px 12px}
    .chip{padding:3px 8px;border-radius:999px;background:#0e1530;border:1px solid var(--line);color:var(--muted);font-size:12px}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#0a0f24;border:1px solid var(--line);padding:0 6px;border-radius:6px}
    .danger-link{color:#ff9a9a;cursor:pointer}
    .ok-link{color:#86efac;cursor:pointer}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .grow{flex:1}
    .pill{display:inline-flex;gap:6px;align-items:center;background:#0d1533;border:1px solid var(--line);padding:6px 10px;border-radius:999px}
    .small{font-size:12px}
    .sticky{position:sticky;top:0;z-index:5}
    .kbdrow{gap:6px}
    .srch{min-width:260px}
    .hr{height:1px;background:var(--line);margin:8px 0}
  </style>
</head>
<body>
  <div class="wrap">

    <div class="panel sticky">
      <div class="flex">
        <h1>üå± SeedOrders ‚Äî wsp√≥lna baza</h1>
        <span id="status" class="tag">status: ‚Ä¶</span>
        <span class="pill small">‚è± <span id="ts"></span></span>
        <span class="right"></span>
        <button id="refreshAll" class="ghost">Od≈õwie≈º wszystko</button>
      </div>
    </div>

    <!-- Cennik -->
    <div class="panel grid" id="panelPrices">
      <div class="flex">
        <h2>Cennik (seedorders_prices)</h2>
        <span class="tag">filtry</span>
        <label class="pill small"><input type="checkbox" id="fRzepak" checked> Rzepak</label>
        <label class="pill small"><input type="checkbox" id="fKukurydza" checked> Kukurydza</label>
        <label class="pill small"><input type="checkbox" id="fZboza" checked> Zbo≈ºa</label>
        <label class="pill small"><input type="checkbox" id="fTrawy" checked> Trawy</label>
        <label class="pill small"><input type="checkbox" id="fInne" checked> Inne</label>
        <span class="right"></span>
        <button class="ghost btn-sm" id="togglePrices">Ukryj</button>
      </div>
      <div id="pricesBody" class="grid">
        <div class="row">
          <select id="pKategoria">
            <option value="Rzepak">Rzepak</option>
            <option value="Kukurydza">Kukurydza</option>
            <option value="Zbo≈ºa">Zbo≈ºa</option>
            <option value="Trawy">Trawy</option>
            <option value="Inne">Inne</option>
          </select>
          <input id="pOdmiana" placeholder="Odmiana" />
          <input id="pCena" type="number" step="0.01" placeholder="Cena" />
          <input id="pDostawca" placeholder="Dostawca (opcjonalnie)" />
          <button id="pSave" class="primary">Zapisz</button>
          <button id="pDelete" class="danger">Usu≈Ñ</button>
          <span class="right"></span>
          <input id="pSearch" class="srch" placeholder="Szukaj w cenniku‚Ä¶" />
        </div>
        <table class="table" id="pricesTable">
          <thead>
            <tr>
              <th>Odmiana</th><th>Kategoria</th><th>Cena</th><th>Dostawca</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Kontrahenci -->
    <div class="panel grid">
      <div class="flex">
        <h2>Kontrahenci (seedorders_clients)</h2>
        <span class="right"></span>
        <button class="ghost btn-sm" id="toggleClients">Ukryj</button>
      </div>
      <div id="clientsBody" class="grid">
        <div class="row">
          <input id="cName" placeholder="Nazwa (np. Jan Kowalski)" class="grow"/>
          <input id="cPhone" placeholder="Telefon" />
          <input id="cAddress" placeholder="Adres (ulica, kod, miejscowo≈õƒá, kraj)" class="grow" />
          <button id="cSave" class="primary">Zapisz</button>
          <button id="cDelete" class="danger">Usu≈Ñ</button>
          <span class="right"></span>
          <input id="cSearch" class="srch" placeholder="Szukaj klienta‚Ä¶" />
          <button id="cRefresh" class="ghost">Od≈õwie≈º listƒô</button>
        </div>
        <table class="table" id="clientsTable">
          <thead>
            <tr><th>Nazwa</th><th>Telefon</th><th>Adres</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Zam√≥wienia -->
    <div class="panel grid">
      <div class="flex">
        <h2>Dodaj zam√≥wienie</h2>
      </div>
      <div class="row">
        <select id="oClient" class="grow"></select>
        <input id="oPhone" placeholder="Telefon (auto)" disabled />
        <select id="oKategoria">
          <option value="Rzepak">Rzepak</option>
          <option value="Kukurydza">Kukurydza</option>
          <option value="Zbo≈ºa">Zbo≈ºa</option>
          <option value="Trawy">Trawy</option>
          <option value="Inne">Inne</option>
        </select>
        <select id="oOdmiana" class="grow"><option value="">Odmiana (wg kategorii)</option></select>
        <input id="oQty" type="number" step="1" value="1" />
        <input id="oPrice" type="number" step="0.01" placeholder="Cena / szt." />
        <input id="oVendor" placeholder="Dostawca (opcjonalnie)" />
        <input id="oNotes" placeholder="Uwagi (opcjonalnie)" class="grow" />
        <button id="oAddItem" class="primary">Dodaj pozycjƒô</button>
      </div>
      <div id="ordersList" class="grid">
        <div class="flex">
          <h2>Zam√≥wienia (ostatnie)</h2>
          <input id="oSearch" class="srch right" placeholder="Szukaj: klient/odmiana/uwagi‚Ä¶" />
          <select id="oStatusFilter">
            <option value="*">Wszystkie statusy</option>
            <option value="zam√≥wione">zam√≥wione</option>
            <option value="dostarczone">dostarczone</option>
          </select>
          <button id="oReload" class="ghost">Od≈õwie≈º</button>
        </div>
        <div id="ordersContainer"></div>
      </div>
    </div>

    <!-- Raporty -->
    <div class="panel grid">
      <div class="flex">
        <h2>Raporty</h2>
      </div>
      <div class="row">
        <input id="rFrom" type="date"/>
        <input id="rTo" type="date"/>
        <select id="rCat">
          <option value="*">(Wszystkie)</option>
          <option value="Rzepak">Rzepak</option>
          <option value="Kukurydza">Kukurydza</option>
          <option value="Zbo≈ºa">Zbo≈ºa</option>
          <option value="Trawy">Trawy</option>
          <option value="Inne">Inne</option>
        </select>
        <button id="rShow" class="ghost">Poka≈º sumy</button>
        <button id="rCSV" class="primary">Pobierz CSV</button>
      </div>
      <table class="table" id="reportTable">
        <thead><tr><th>Kategoria</th><th>Odmiana</th><th>Zam√≥wiono</th><th>Wydano</th><th>Pozosta≈Ço</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="small muted">Zakres: <span id="rRange"></span></div>
    </div>

  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script>
  // ====== KONFIGURACJA STA≈ÅA (Twoje klucze) ======
  const SUPABASE_URL = "https://zseqkyjcqkuvrqxluihs.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzZXFreWpjcWt1dnJxeGx1aWhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNDk2NjUsImV4cCI6MjA3NjkyNTY2NX0.ubbYQzYWiMyETohwKRnVQZaZRoIA-zwiX2YsY8TPsDk";
  const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {auth: {persistSession:false}});

  // ====== POMOCNICZE ======
  const $ = sel => document.querySelector(sel);
  const $$ = sel => document.querySelectorAll(sel);
  const fmt = n=> (n??0).toLocaleString('pl-PL');
  const nowISO = ()=> new Date().toISOString();
  const sleep = ms=> new Promise(r=>setTimeout(r,ms));
  const setStatus = async () => {
    const { error } = await db.from('seedorders_prices').select('id').limit(1);
    const s = $('#status');
    s.textContent = error ? 'status: offline' : 'status: online';
    s.style.color = error ? '#ff9a9a' : '#7cf2a2';
    $('#ts').textContent = new Date().toLocaleTimeString();
  };

  const CAT_FLAGS = {
    'Rzepak':'fRzepak','Kukurydza':'fKukurydza','Zbo≈ºa':'fZboza','Trawy':'fTrawy','Inne':'fInne'
  };

  // ====== CENNIK ======
  let prices = [];
  let selectedPriceId = null;
  const categoryAllowed = kat => {
    return (kat==='Rzepak'   && $('#fRzepak').checked) ||
           (kat==='Kukurydza'&& $('#fKukurydza').checked) ||
           (kat==='Zbo≈ºa'    && $('#fZboza').checked) ||
           (kat==='Trawy'    && $('#fTrawy').checked) ||
           (kat==='Inne'     && $('#fInne').checked);
  };

  async function loadPrices(){
    const { data, error } = await db.from('seedorders_prices')
      .select('id,odmiana,kategoria,cena,dostawca,created_at')
      .order('odmiana',{ascending:true});
    if(error){ console.error(error); return; }
    prices = data;
    renderPrices();
    fillOdmianyFor($('#oKategoria').value);
  }

  function renderPrices(){
    const q = ($('#pSearch').value||'').toLowerCase();
    const tbody = $('#pricesTable tbody');
    tbody.innerHTML = '';
    prices.filter(r => categoryAllowed(r.kategoria))
          .filter(r => !q || (r.odmiana+' '+r.kategoria+' '+(r.dostawca||'')).toLowerCase().includes(q))
          .forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.odmiana}</td>
        <td>${r.kategoria}</td>
        <td>${Number(r.cena??0).toFixed(2)} z≈Ç</td>
        <td>${r.dostawca||''}</td>
        <td><button class="btn-sm ghost">Edytuj</button></td>
      `;
      tr.querySelector('button').onclick = () => {
        selectedPriceId = r.id;
        $('#pOdmiana').value = r.odmiana;
        $('#pKategoria').value = r.kategoria;
        $('#pCena').value = r.cena;
        $('#pDostawca').value = r.dostawca||'';
      };
      tbody.appendChild(tr);
    });
  }

  async function savePrice(){
    const row = {
      odmiana: $('#pOdmiana').value.trim(),
      kategoria: $('#pKategoria').value,
      cena: Number($('#pCena').value||0),
      dostawca: $('#pDostawca').value.trim()||null,
      created_at: nowISO()
    };
    if(!row.odmiana){ alert('Podaj odmianƒô.'); return; }
    if(selectedPriceId){
      const { error } = await db.from('seedorders_prices').update(row).eq('id', selectedPriceId);
      if(error){ alert('B≈ÇƒÖd cennika (edycja): '+error.message); return; }
    }else{
      const { error } = await db.from('seedorders_prices').insert(row);
      if(error){ alert('B≈ÇƒÖd cennika (zapis): '+error.message); return; }
    }
    selectedPriceId = null;
    $('#pOdmiana').value=''; $('#pCena').value=''; $('#pDostawca').value='';
    await loadPrices();
  }
  async function deletePrice(){
    if(!selectedPriceId){ alert('Najpierw wybierz pozycjƒô (Edytuj).'); return; }
    if(!confirm('UsunƒÖƒá pozycjƒô z cennika?')) return;
    const { error } = await db.from('seedorders_prices').delete().eq('id', selectedPriceId);
    if(error){ alert('B≈ÇƒÖd usuwania: '+error.message); return; }
    selectedPriceId=null; await loadPrices();
  }

  // ====== KONTRAHENCI ======
  let clients = [];
  let selectedClientId = null;

  async function loadClients(){
    const { data, error } = await db.from('seedorders_clients')
      .select('id,name,phone,address').order('name',{ascending:true});
    if(error){ console.error(error); return; }
    clients = data;
    renderClients();
    fillClientsSelect();
  }
  function renderClients(){
    const q = ($('#cSearch').value||'').toLowerCase();
    const tbody = $('#clientsTable tbody'); tbody.innerHTML='';
    clients.filter(r => !q || (r.name+' '+(r.phone||'')+' '+(r.address||'')).toLowerCase().includes(q))
      .forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${r.name}</td>
          <td>${r.phone||''}</td>
          <td>${r.address||''}</td>
          <td><button class="btn-sm ghost">Edytuj</button></td>
        `;
        tr.querySelector('button').onclick = ()=>{
          selectedClientId = r.id;
          $('#cName').value = r.name;
          $('#cPhone').value = r.phone||'';
          $('#cAddress').value = r.address||'';
        };
        tbody.appendChild(tr);
      });
  }
  async function saveClient(){
    const row = {
      name: $('#cName').value.trim(),
      phone: $('#cPhone').value.trim()||null,
      address: $('#cAddress').value.trim()||null
    };
    if(!row.name){ alert('Podaj nazwƒô kontrahenta.'); return; }
    if(selectedClientId){
      const { error } = await db.from('seedorders_clients').update(row).eq('id', selectedClientId);
      if(error){ alert('B≈ÇƒÖd edycji klienta: '+error.message); return; }
    }else{
      const { error } = await db.from('seedorders_clients').insert(row);
      if(error){ alert('B≈ÇƒÖd dodawania klienta: '+error.message); return; }
    }
    selectedClientId=null; $('#cName').value=''; $('#cPhone').value=''; $('#cAddress').value='';
    await loadClients();
  }
  async function deleteClient(){
    if(!selectedClientId){ alert('Najpierw wybierz klienta (Edytuj).'); return; }
    if(!confirm('UsunƒÖƒá kontrahenta i jego zam√≥wienia?')) return;
    const { error } = await db.from('seedorders_clients').delete().eq('id', selectedClientId);
    if(error){ alert('B≈ÇƒÖd usuwania klienta: '+error.message); return; }
    selectedClientId=null; await loadClients(); await loadOrders();
  }
  function fillClientsSelect(){
    const sel = $('#oClient'); sel.innerHTML='';
    clients.forEach(c=>{
      const opt=document.createElement('option');
      opt.value=c.id; opt.textContent=c.name;
      sel.appendChild(opt);
    });
    const cur = clients.find(c=>c.id===sel.value);
    $('#oPhone').value = cur? (cur.phone||'') : '';
  }
  $('#oClient').addEventListener('change', ()=>{
    const id = $('#oClient').value;
    const c = clients.find(x=>x.id===id);
    $('#oPhone').value = c? (c.phone||'') : '';
  });

  // ====== ZAM√ìWIENIA ======
  async function upsertOrderForSelectedClient(){
    const id = $('#oClient').value;
    const c = clients.find(x=>x.id===id);
    if(!c){ alert('Wybierz klienta.'); return null; }
    // Sprawd≈∫, czy istnieje "otwarte" zam√≥wienie (zam√≥wione) z dzi≈õ ‚Äì je≈õli nie, stw√≥rz.
    const { data, error } = await db.from('seedorders_orders')
      .select('id').eq('client_id', c.id).order('created_at',{ascending:false}).limit(1);
    if(error){ alert('B≈ÇƒÖd odczytu zam√≥wie≈Ñ: '+error.message); return null; }
    let orderId = data?.[0]?.id || null;
    if(!orderId){
      const ins = {
        client_id: c.id,
        client: c.name,
        phone: c.phone||null,
        notes: ($('#oNotes').value||null),
        status: 'zam√≥wione',
        created_at: nowISO()
      };
      const { data:created, error:err2 } = await db.from('seedorders_orders').insert(ins).select('id').single();
      if(err2){ alert('B≈ÇƒÖd tworzenia nag≈Ç√≥wka zam√≥wienia: '+err2.message); return null; }
      orderId = created.id;
    }
    return orderId;
  }

  function fillOdmianyFor(kat){
    const sel=$('#oOdmiana'); sel.innerHTML='<option value="">Odmiana (wg kategorii)</option>';
    prices.filter(p=>p.kategoria===kat).forEach(p=>{
      const o=document.createElement('option');
      o.value=p.odmiana; o.textContent=`${p.odmiana}${p.dostawca?` ‚Ä¢ ${p.dostawca}`:''} (${Number(p.cena||0).toFixed(2)} z≈Ç)`;
      sel.appendChild(o);
    });
  }
  $('#oKategoria').addEventListener('change', ()=> fillOdmianyFor($('#oKategoria').value));

  async function addOrderItem(){
    const orderId = await upsertOrderForSelectedClient();
    if(!orderId) return;

    const kat=$('#oKategoria').value;
    const odm=$('#oOdmiana').value||$('#pOdmiana').value.trim();
    if(!odm){ alert('Wybierz odmianƒô.'); return; }
    const qty = Number($('#oQty').value||0);
    if(qty<=0){ alert('Podaj ilo≈õƒá > 0.'); return; }
    const price = ($('#oPrice').value===''? null : Number($('#oPrice').value));
    const vendor = $('#oVendor').value.trim()||null;

    const row = {
      order_id: orderId,
      kategoria: kat,
      odmiana: odm,
      cena: price,
      dostawca: vendor,
      ordered_qty: qty,
      delivered_qty: 0,
      created_at: nowISO()
    };

    // Zapis pozycji (wspiera te≈º stare nazwy kolumn, je≈õli takie zosta≈Çy)
    let { error } = await db.from('seedorders_items').insert(row);
    if(error && /column .* does not exist/i.test(error.message)){
      // Fallback do starych nazw: ilosc/wydano
      const legacy = {
        order_id: orderId,
        kategoria: kat,
        odmiana: odm,
        cena: price,
        dostawca: vendor,
        ilosc: qty,
        wydano: 0,
        created_at: nowISO()
      };
      const r2 = await db.from('seedorders_items').insert(legacy);
      if(r2.error){ alert('B≈ÇƒÖd pozycji: '+r2.error.message); return; }
    }else if(error){
      alert('B≈ÇƒÖd pozycji: '+error.message); return;
    }

    $('#oOdmiana').value=''; $('#oQty').value=1; $('#oPrice').value=''; $('#oVendor').value='';
    await loadOrders();
    await loadReport(); // raport siƒô automatycznie zaktualizuje
  }

  async function changeDelivery(itemId, delta){
    // Pobierz rekord
 const { data, error } = await db.from('seedorders_items')
  .select('id, ordered_qty, delivered_qty, order_id')
  .eq('id', itemId).single();

    if(error){ alert('B≈ÇƒÖd odczytu pozycji: '+error.message); return; }
    // Wersja nowa/stara
    const ord = data.ordered_qty ?? data.ilosc ?? 0;
    const del = data.delivered_qty ?? data.wydano ?? 0;
    let next = Math.max(0, Math.min(ord, del + delta));

    // Aktualizacja
    let upd = {};
    if('delivered_qty' in data || !('wydano' in data)) upd.delivered_qty = next;
    if('wydano' in data) upd.wydano = next;

    const u = await db.from('seedorders_items').update(upd).eq('id', itemId);
    if(u.error){ alert('B≈ÇƒÖd wydania: '+u.error.message); return; }

    await updateOrderStatusByItems(data.order_id);
    await loadOrders();
    await loadReport();
  }

  async function updateOrderStatusByItems(orderId){
    // Pobierz pozycje i wylicz status
  const { data, error } = await db.from('seedorders_items')
  .select('ordered_qty, delivered_qty')
  .eq('order_id', orderId);

    if(error) return;
    let totalOrd=0, totalDel=0;
    data.forEach(r=>{
      totalOrd += (r.ordered_qty ?? r.ilosc ?? 0);
      totalDel += (r.delivered_qty ?? r.wydano ?? 0);
    });
    let status = 'zam√≥wione';
    if(totalDel>0 && totalDel<totalOrd) status='czƒô≈õciowo';
    if(totalOrd>0 && totalDel>=totalOrd) status='dostarczone';
    await db.from('seedorders_orders').update({status}).eq('id', orderId);
  }

  async function deleteOrder(orderId){
    if(!confirm('UsunƒÖƒá ca≈Çe zam√≥wienie?')) return;
    // kolejno≈õƒá bez FK CASCADE
    await db.from('seedorders_items').delete().eq('order_id', orderId);
    await db.from('seedorders_orders').delete().eq('id', orderId);
    await loadOrders(); await loadReport();
  }

  async function deleteItem(itemId, orderId){
    if(!confirm('UsunƒÖƒá pozycjƒô?')) return;
    await db.from('seedorders_items').delete().eq('id', itemId);
    await updateOrderStatusByItems(orderId);
    await loadOrders(); await loadReport();
  }

  let orders = [];
  async function loadOrders(){
    const { data, error } = await db.from('seedorders_orders')
      .select('id,client,phone,notes,status,created_at')
      .order('created_at', {ascending:false}).limit(100);
    if(error){ console.error(error); return; }
    orders = data;
    await renderOrders();
  }

  async function loadItemsFor(orderId){
   const { data, error } = await db.from('seedorders_items')
  .select('id,kategoria,odmiana,cena,dostawca,ordered_qty,delivered_qty,order_id')
  .eq('order_id', orderId);

    if(error){ console.error(error); return []; }
    return data.map(r=>({
      id:r.id,
      kategoria:r.kategoria, odmiana:r.odmiana, cena:r.cena, dostawca:r.dostawca,
      ordered: r.ordered_qty ?? r.ilosc ?? 0,
      delivered: r.delivered_qty ?? r.wydano ?? 0,
      remaining: Math.max(0, (r.ordered_qty ?? r.ilosc ?? 0) - (r.delivered_qty ?? r.wydano ?? 0))
    }));
  }

  async function renderOrders(){
    const q = ($('#oSearch').value||'').toLowerCase();
    const only = $('#oStatusFilter').value;
    const box = $('#ordersContainer'); box.innerHTML='';

    for(const o of orders){
      const items = await loadItemsFor(o.id);
      const totalOrd = items.reduce((a,b)=>a+b.ordered,0);
      const totalDel = items.reduce((a,b)=>a+b.delivered,0);
      const totalRem = Math.max(0, totalOrd-totalDel);

      // filtr
      const hay = (o.client+' '+(o.notes||'')+' '+items.map(i=>i.odmiana).join(' ')).toLowerCase();
      if(q && !hay.includes(q)) continue;
      if(only!=='*' && o.status!==only) continue;

      // kolor/status
      let cls='sok', label='zam√≥wione';
      if(totalDel>0 && totalDel<totalOrd){ cls='swarn'; label='czƒô≈õciowo'; }
      if(totalRem===0 && totalOrd>0){ cls='sdanger'; label='dostarczone'; }

      const card = document.createElement('div');
      card.className='order';
      card.innerHTML = `
        <div class="order-header">
          <span class="status ${cls}">${label}</span>
          <span class="chip">${new Date(o.created_at).toLocaleDateString('pl-PL')}</span>
          <b>${o.client}</b> ¬∑ <span class="muted">${o.phone||''}</span>
          <span class="tag">Pozosta≈Ço: ${fmt(totalRem)}</span>
          ${o.notes? `<span class="chip">Uwagi: ${o.notes}</span>`:''}
          <span class="right"></span>
          <select class="btn-sm ghost" data-st="${o.id}">
            <option ${o.status==='zam√≥wione'?'selected':''}>zam√≥wione</option>
            <option ${o.status==='dostarczone'?'selected':''}>dostarczone</option>
          </select>
          <button class="btn-sm danger" data-del="${o.id}">Usu≈Ñ</button>
        </div>
        <div class="order-body">
          <table class="table">
            <thead><tr><th>Odmiana</th><th>Zam.</th><th>Wydano</th><th>Pozosta≈Ço</th><th>Wydaj</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      `;
      const tbody = card.querySelector('tbody');
      items.forEach(it=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${it.kategoria} ‚Ä¢ ${it.odmiana}</td>
          <td>${fmt(it.ordered)}</td>
          <td>${fmt(it.delivered)}</td>
          <td>${fmt(it.remaining)}</td>
          <td class="kbdrow">
            <button class="btn-sm ghost" data-minus="${it.id}">‚Äì1</button>
            <button class="btn-sm ghost" data-plus="${it.id}">+1</button>
          </td>
          <td><span class="danger-link" data-delitem="${it.id}" data-order="${o.id}">Usu≈Ñ</span></td>
        `;
        tbody.appendChild(tr);
      });

      // akcje
      card.querySelector(`[data-del="${o.id}"]`).onclick=()=>deleteOrder(o.id);
      card.querySelector(`[data-st="${o.id}"]`).onchange=async (e)=>{
        await db.from('seedorders_orders').update({status:e.target.value}).eq('id',o.id);
        await renderOrders();
      };
      card.querySelectorAll('[data-minus]').forEach(b=>b.onclick=()=>changeDelivery(b.dataset.minus,-1));
      card.querySelectorAll('[data-plus]').forEach(b=>b.onclick =()=>changeDelivery(b.dataset.plus,+1));
      card.querySelectorAll('[data-delitem]').forEach(b=>b.onclick=()=>deleteItem(b.dataset.delitem,b.dataset.order));

      box.appendChild(card);
    }
  }

  // ====== RAPORT ======
  function setDefaultReportRange(){
    const d=new Date(), d2=new Date();
    d.setDate(d.getDate()-30);
    $('#rFrom').value = d.toISOString().slice(0,10);
    $('#rTo').value = d2.toISOString().slice(0,10);
  }

  async function loadReport(){
    const from = $('#rFrom').value || '1970-01-01';
    const to   = $('#rTo').value   || new Date().toISOString().slice(0,10);
    const cat = $('#rCat').value;

    // Pobierz pozycje z zam√≥wie≈Ñ w zakresie dat po dacie utworzenia zam√≥wienia
    const { data:ordersIn, error:oerr } = await db.from('seedorders_orders')
      .select('id,created_at').gte('created_at', from).lte('created_at', to+'T23:59:59');
    if(oerr){ console.error(oerr); return; }
    const ids = ordersIn.map(o=>o.id);
    if(ids.length===0){ $('#reportTable tbody').innerHTML=''; $('#rRange').textContent=`${from} ‚Äì ${to}`; return; }

    const { data:items, error } = await db.from('seedorders_items')
      .select('kategoria,odmiana,ordered_qty,delivered_qty,ilosc,wydano,order_id')
      .in('order_id', ids);
    if(error){ console.error(error); return; }

    // Agregacja
    const agg = new Map();
    for(const r of items){
      const k = r.kategoria || 'Inne';
      if(cat!=='*' && k!==cat) continue;
      const key = `${k}|||${r.odmiana}`;
      const ord = (r.ordered_qty ?? r.ilosc ?? 0);
      const del = (r.delivered_qty ?? r.wydano ?? 0);
      const cur = agg.get(key) || {kategoria:k, odmiana:r.odmiana, zam:0, wyd:0};
      cur.zam += ord; cur.wyd += del; agg.set(key,cur);
    }
    const rows = [...agg.values()].sort((a,b)=> a.kategoria.localeCompare(b.kategoria) || a.odmiana.localeCompare(b.odmiana));
    const tbody = $('#reportTable tbody'); tbody.innerHTML='';
    let sumZ=0,sumW=0;
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      const rem = Math.max(0, r.zam-r.wyd);
      tr.innerHTML=`<td>${r.kategoria}</td><td>${r.odmiana}</td><td>${fmt(r.zam)}</td><td>${fmt(r.wyd)}</td><td>${fmt(rem)}</td>`;
      tbody.appendChild(tr);
      sumZ+=r.zam; sumW+=r.wyd;
    });
    const tr=document.createElement('tr');
    tr.innerHTML=`<th colspan="2">RAZEM</th><th>${fmt(sumZ)}</th><th>${fmt(sumW)}</th><th>${fmt(Math.max(0,sumZ-sumW))}</th>`;
    tbody.appendChild(tr);
    $('#rRange').textContent = `${from} ‚Äì ${to}`;
  }

  function downloadCSV(){
    const rows=[['Kategoria','Odmiana','Zam√≥wiono','Wydano','Pozosta≈Ço']];
    $('#reportTable tbody tr').forEach((tr,i)=>{
      const cells=[...tr.children].map(td=>td.textContent);
      if(i===Array.from($('#reportTable tbody tr')).length-1) return; // pomi≈Ñ RAZEM
      rows.push(cells);
    });
    const csv = rows.map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(';')).join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`raport_${$('#rFrom').value}_${$('#rTo').value}.csv`; a.click();
  }

  // ====== ZDARZENIA UI ======
  $('#refreshAll').onclick = async ()=>{ await setStatus(); await loadPrices(); await loadClients(); await loadOrders(); await loadReport(); };
  $('#togglePrices').onclick = ()=> {
    const b=$('#pricesBody'); const btn=$('#togglePrices');
    const hide=b.style.display==='none'; b.style.display = hide?'grid':'none'; btn.textContent = hide?'Ukryj':'Poka≈º';
  };
  $('#toggleClients').onclick = ()=> {
    const b=$('#clientsBody'); const btn=$('#toggleClients');
    const hide=b.style.display==='none'; b.style.display = hide?'grid':'none'; btn.textContent = hide?'Ukryj':'Poka≈º';
  };
  $('#pSave').onclick=savePrice; $('#pDelete').onclick=deletePrice; $('#pSearch').oninput=renderPrices;
  $('#fRzepak').onchange=renderPrices; $('#fKukurydza').onchange=renderPrices; $('#fZboza').onchange=renderPrices; $('#fTrawy').onchange=renderPrices; $('#fInne').onchange=renderPrices;
  $('#cSave').onclick=saveClient; $('#cDelete').onclick=deleteClient; $('#cSearch').oninput=renderClients; $('#cRefresh').onclick=loadClients;
  $('#oAddItem').onclick=addOrderItem; $('#oSearch').oninput=renderOrders; $('#oStatusFilter').onchange=renderOrders; $('#oReload').onclick=loadOrders;
  $('#rShow').onclick=loadReport; $('#rCSV').onclick=downloadCSV;

  // ====== START ======
  (async function boot(){
    setDefaultReportRange();
    await setStatus();
    await loadPrices();
    await loadClients();
    fillOdmianyFor($('#oKategoria').value);
    await loadOrders();
    await loadReport();
  })();
    async function loadReport(){
  const from = $('#rFrom').value || '2000-01-01';
  const to = $('#rTo').value || '2100-01-01';
  const cat = $('#rCat').value;

  // Pobierz dane z przedzia≈Çu dat
  let query = db.from('seedorders_items')
    .select('odmiana, kategoria, ordered_qty, delivered_qty, created_at')
    .gte('created_at', from)
    .lte('created_at', to);

  // Filtrowanie po kategorii
  if(cat && cat !== 'Wszystkie') query = query.eq('kategoria', cat);

  const { data, error } = await query;
  if(error){ alert('B≈ÇƒÖd raportu: ' + error.message); return; }

  // Sumowanie ilo≈õci zam√≥wionych i wydanych dla ka≈ºdej odmiany
  const sums = {};
  data.forEach(r => {
    if(!sums[r.odmiana]) sums[r.odmiana] = { kategoria: r.kategoria, zam: 0, wyd: 0 };
    sums[r.odmiana].zam += r.ordered_qty || 0;
    sums[r.odmiana].wyd += r.delivered_qty || 0;
  });

  // Renderowanie tabeli raportu
  const tbody = $('#reportTable tbody');
  tbody.innerHTML = '';
  Object.entries(sums).forEach(([odmiana, s]) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${s.kategoria}</td>
      <td>${odmiana}</td>
      <td>${s.zam}</td>
      <td>${s.wyd}</td>
      <td>${s.zam - s.wyd}</td>
    `;
    tbody.appendChild(tr);
  });

  $('#rRange').textContent = `${from} ‚Üí ${to}`;
}

  </script>
</body>
</html>


