<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SeedOrders — wspólna baza</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#111936; --muted:#99a6c0; --text:#e9f0ff;
      --accent:#36d399; --accent2:#60a5fa; --danger:#ef4444; --line:#2a345a;
      --chip:#101827;
    }
    *{box-sizing:border-box}
    body{margin:0;font:15px/1.4 ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg)}
    .wrap{max-width:1200px;margin:auto;padding:16px;display:grid;gap:16px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    h1{font-size:20px;margin:0}
    h2{font-size:16px;margin:0 0 6px 0;color:#dbe7ff}
    input,select,button,textarea{background:#0e1436;border:1px solid var(--line);color:#e9f0ff;padding:10px;border-radius:10px;outline:none}
    input::placeholder,textarea::placeholder{color:#7481a8}
    button{cursor:pointer}
    button.primary{background:var(--accent);color:#042016;font-weight:600;border:0}
    button.warn{background:#0e1436;border:1px solid #facc15;color:#facc15}
    button.danger{background:#700b0b;border:1px solid #ef4444;color:#ffdddd}
    button.ghost{background:#0e1436}
    .btn-sm{padding:6px 10px;border-radius:8px;font-size:12px}
    .right{margin-left:auto}
    .grid{display:grid;gap:10px}
    .row{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:10px}
    @media (max-width:1000px){ .row{grid-template-columns:repeat(2,minmax(0,1fr))} }
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:8px 10px;text-align:left}
    .muted{color:var(--muted)}
    .status{font-weight:700;padding:2px 8px;border-radius:999px}
    .sok{background:#19351f;color:#78f5a9;border:1px solid #245f39}
    .swarn{background:#3b2d1a;color:#facc15;border:1px solid #6b4f17}
    .sdanger{background:#402431;color:#ff9ab1;border:1px solid #7a2b45}
    .chip{background:var(--chip);border:1px dashed var(--line);padding:4px 8px;border-radius:999px;font-size:12px}
    .order{display:grid;gap:10px;border:1px dashed var(--line);padding:10px;border-radius:12px;background:#0c1433}
    .order-header{display:flex;gap:10px;align-items:center;border-bottom:1px dashed var(--line);padding-bottom:6px}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0e1b44;padding:2px 6px;border-radius:6px;border:1px solid #26306a}
    .sticky{position:sticky;top:0;z-index:5}
    .pill{display:inline-flex;gap:8px;align-items:center}
    .small{font-size:12px}
  </style>
</head>
<body>
<div class="wrap">

  <div class="flex">
    <h1>SeedOrders — wspólna baza</h1>
    <span id="status" class="chip sdanger">status: offline</span>
    <span id="ts" class="chip"></span>
    <span class="right"></span>
    <button id="refreshAll" class="ghost">Odśwież wszystko</button>
  </div>

  <!-- Cennik -->
  <div class="panel grid">
    <div class="flex sticky">
      <h2>Cennik (<span class="kbd">seedorders_prices</span>)</h2>
      <span class="right"></span>
      <button id="togglePrices" class="ghost btn-sm">Ukryj</button>
    </div>
    <div id="pricesBody" class="grid">
      <div class="row">
        <select id="pKategoria">
          <option value="Rzepak">Rzepak</option>
          <option value="Kukurydza">Kukurydza</option>
          <option value="Zboża">Zboża</option>
          <option value="Trawy">Trawy</option>
          <option value="Inne">Inne</option>
        </select>
        <input id="pOdmiana" placeholder="Odmiana" />
        <input id="pCena" type="number" step="0.01" placeholder="Cena / szt." />
        <input id="pDostawca" placeholder="Dostawca (opcjonalnie)" />
        <button id="pSave" class="primary">Zapisz</button>
        <input id="pSearch" class="right" placeholder="Szukaj w cenniku…" />
      </div>
      <table class="table" id="pricesTable">
        <thead><tr><th>Odmiana</th><th>Kategoria</th><th>Cena</th><th>Dostawca</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Kontrahenci -->
  <div class="panel grid">
    <div class="flex">
      <h2>Kontrahenci (<span class="kbd">seedorders_clients</span>)</h2>
      <span class="right"></span>
      <button id="toggleClients" class="ghost btn-sm">Ukryj</button>
    </div>
    <div id="clientsBody" class="grid">
      <div class="row">
        <input id="cName" placeholder="Nazwa (np. Jan Kowalski)" />
        <input id="cPhone" placeholder="Telefon" />
        <input id="cAddress" placeholder="Adres (ulica, kod, miejscowość, kraj)" />
        <button id="cSave" class="primary">Zapisz</button>
        <button id="cDelete" class="danger">Usuń</button>
        <input id="cSearch" class="right" placeholder="Szukaj klienta…" />
      </div>
      <div class="flex pill small muted">
        <span>Tip: kliknij wiersz, aby wczytać do edycji</span>
        <span class="right"></span>
        <button id="cRefresh" class="ghost btn-sm">Odśwież</button>
      </div>
      <table class="table" id="clientsTable">
        <thead><tr><th>Nazwa</th><th>Telefon</th><th>Adres</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Dodaj zamówienie -->
  <div class="panel grid">
    <h2>Dodaj zamówienie</h2>
    <div class="row">
      <select id="oClient"></select>
      <input id="oPhone" placeholder="Telefon (auto)" />
      <input id="oNotes" placeholder="Uwagi (opcjonalnie)" />
      <span></span><span></span><span></span>
    </div>
    <div class="row">
      <select id="oKategoria">
        <option>Rzepak</option><option>Kukurydza</option><option>Zboża</option>
        <option>Trawy</option><option>Inne</option>
      </select>
      <select id="oOdmiana"><option value="">Odmiana (wg kategorii)</option></select>
      <input id="oQty" type="number" min="1" value="1" placeholder="Ilość" />
      <input id="oPrice" type="number" step="0.01" placeholder="Cena / szt." />
      <input id="oVendor" placeholder="Dostawca (opcjonalnie)" />
      <button id="addItem" class="primary">Dodaj pozycję</button>
    </div>
  </div>

  <!-- Zamówienia -->
  <div class="panel grid">
    <div class="flex">
      <h2>Zamówienia (ostatnie)</h2>
      <span class="right"></span>
    </div>
    <div class="flex">
      <input id="oSearch" placeholder="Szukaj: klient/odmiana/uwagi…" class="right" />
      <select id="oStatusFilter">
        <option value="">Wszystkie statusy</option>
        <option value="zamówione">zamówione</option>
        <option value="częściowo">częściowo</option>
        <option value="dostarczone">dostarczone</option>
      </select>
      <button id="oReload" class="ghost">Odśwież</button>
    </div>
    <div id="ordersContainer"></div>
  </div>

  <!-- Raport -->
  <div class="panel grid">
    <div class="flex"><h2>Raport</h2></div>
    <div class="row">
      <input id="rFrom" type="date" />
      <input id="rTo" type="date" />
      <select id="rCat">
        <option value="">(wszystkie)</option>
        <option value="Rzepak">Rzepak</option>
        <option value="Kukurydza">Kukurydza</option>
        <option value="Zboża">Zboża</option>
        <option value="Trawy">Trawy</option>
        <option value="Inne">Inne</option>
      </select>
      <button id="rShow" class="ghost">Pokaż</button>
      <button id="rCSV"  class="ghost">CSV</button>
      <span id="rRange" class="chip"></span>
    </div>
    <table class="table">
      <thead>
        <tr>
          <th>Kategoria</th><th>Odmiana</th><th>Zam.</th><th>Wyd.</th><th>Pozost.</th>
        </tr>
      </thead>
      <tbody id="reportT"></tbody>
    </table>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script>
  // ====== KONFIGURACJA SUPABASE ======
  const SUPABASE_URL  = 'https://zseqkyjcqkuvrqxluihs.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzZXFreWpjcWt1dnJxeGx1aWhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNDk2NjUsImV4cCI6MjA3NjkyNTY2NX0.ubbYQzYWiMyETohwKRnVQZaZRoIA-zwiX2YsY8TPsDk';
  const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession:false }});

  // ====== POMOCNICZE ======
  const $  = sel => document.querySelector(sel);
  const $$ = sel => document.querySelectorAll(sel);
  const fmt = n => (n??0).toLocaleString('pl-PL');
  const nowISO = () => new Date().toISOString();

  async function setStatus(){
    try{
      const { error } = await db.from('seedorders_prices').select('id').limit(1);
      const s = $('#status');
      if(error){ s.textContent='status: offline'; s.className='chip sdanger'; }
      else{ s.textContent='status: online'; s.className='chip sok'; }
    }catch(_){ const s=$('#status'); s.textContent='status: offline'; s.className='chip sdanger'; }
    $('#ts').textContent = new Date().toLocaleTimeString('pl-PL');
  }

  // ====== CENNIK ======
  let prices=[], selectedPriceId=null;
  async function loadPrices(){
    const { data } = await db.from('seedorders_prices')
      .select('id,odmiana,kategoria,cena,dostawca,created_at')
      .order('odmiana',{ascending:true});
    prices=data||[]; renderPrices();
  }
  function renderPrices(){
    const q = ($('#pSearch').value||'').toLowerCase();
    const tbody=$('#pricesTable tbody'); tbody.innerHTML='';
    (prices||[]).filter(r=>{
      const s=`${r.odmiana||''} ${r.kategoria||''} ${r.dostawca||''}`.toLowerCase();
      return !q || s.includes(q);
    }).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${r.odmiana||''}</td>
        <td>${r.kategoria||''}</td>
        <td>${Number(r.cena||0).toFixed(2)}</td>
        <td>${r.dostawca||''}</td>
        <td><button class="btn-sm ghost">Edytuj</button></td>`;
      tr.querySelector('button').onclick=()=>{
        selectedPriceId=r.id;
        $('#pOdmiana').value=r.odmiana||'';
        $('#pKategoria').value=r.kategoria||'Rzepak';
        $('#pCena').value=r.cena||'';
        $('#pDostawca').value=r.dostawca||'';
      };
      tbody.appendChild(tr);
    });
  }
  async function savePrice(){
    const row={
      odmiana:($('#pOdmiana').value||'').trim(),
      kategoria:$('#pKategoria').value,
      cena:Number($('#pCena').value||null),
      dostawca:($('#pDostawca').value||'').trim()||null,
      created_at:nowISO()
    };
    if(!row.odmiana){ alert('Podaj odmianę.'); return; }
    if(selectedPriceId){
      await db.from('seedorders_prices').update(row).eq('id',selectedPriceId);
    }else{
      await db.from('seedorders_prices').insert(row);
    }
    selectedPriceId=null; $('#pOdmiana').value=''; $('#pKategoria').value='Rzepak'; $('#pCena').value=''; $('#pDostawca').value='';
    await loadPrices();
  }

  // ====== KONTRAHENCI ======
  let clients=[], selectedClientId=null;
  async function loadClients(){
    const { data } = await db.from('seedorders_clients').select('id,name,phone,address').order('name',{ascending:true});
    clients=data||[]; renderClients(); fillClientsSelect();
  }
  function renderClients(){
    const q=($('#cSearch').value||'').toLowerCase();
    const tbody=$('#clientsTable tbody'); tbody.innerHTML='';
    clients.filter(r=>!q||(`${r.name||''} ${r.phone||''} ${r.address||''}`.toLowerCase().includes(q)))
      .forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${r.name||''}</td><td>${r.phone||''}</td><td>${r.address||''}</td><td><button class="btn-sm ghost">Edytuj</button></td>`;
        tr.querySelector('button').onclick=()=>{
          selectedClientId=r.id; $('#cName').value=r.name||''; $('#cPhone').value=r.phone||''; $('#cAddress').value=r.address||'';
        };
        tbody.appendChild(tr);
      });
  }
  async function saveClient(){
    const row={ name:($('#cName').value||'').trim(), phone:($('#cPhone').value||'').trim()||null, address:($('#cAddress').value||'').trim()||null };
    if(!row.name){ alert('Podaj nazwę.'); return; }
    if(selectedClientId){ await db.from('seedorders_clients').update(row).eq('id',selectedClientId); }
    else{ await db.from('seedorders_clients').insert(row); }
    selectedClientId=null; await loadClients();
  }
  async function deleteClient(){
    if(selectedClientId){ if(!confirm('Usunąć zaznaczonego kontrahenta?')) return;
      await db.from('seedorders_clients').delete().eq('id',selectedClientId);
      selectedClientId=null; await loadClients(); return;
    }
    const name=(($('#cName').value)||'').trim(); if(!name){ alert('Zaznacz wiersz lub wpisz nazwę do usunięcia.'); return; }
    if(!confirm(`Usunąć klienta: ${name}?`)) return;
    await db.from('seedorders_clients').delete().eq('name',name); await loadClients();
  }
  function fillClientsSelect(){
    const sel=$('#oClient'); sel.innerHTML='';
    (clients||[]).forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.name||'(bez nazwy)'; sel.appendChild(o); });
    const first=clients?.[0]; $('#oPhone').value=first?.phone||'';
    sel.onchange=()=>{ const c=clients.find(x=>String(x.id)===String(sel.value)); $('#oPhone').value=c?.phone||''; };
  }

  // ====== ZAMÓWIENIA ======
  let orders=[];
  function fillOdmianyFor(kat){
    const sel=$('#oOdmiana'); sel.innerHTML=`<option value="">Odmiana (wg kategorii)</option>`;
    (prices||[]).filter(p=>p.kategoria===kat).forEach(p=>{
      const o=document.createElement('option');
      o.value=p.odmiana; o.textContent=`${p.odmiana}${p.dostawca?` (${p.dostawca})`:''} — ${Number(p.cena||0).toFixed(2)} zł`;
      sel.appendChild(o);
    });
  }
  $('#oKategoria').addEventListener('change',()=>fillOdmianyFor($('#oKategoria').value));

  async function upsertOrderForSelectedClient(){
    const sel=$('#oClient'); const c=clients.find(x=>String(x.id)===String(sel.value))||{};
    if(!c.id){ alert('Wybierz klienta.'); return null; }
    const { data } = await db.from('seedorders_orders').select('id,created_at').eq('client_id',c.id).order('created_at',{ascending:false}).limit(1);
    let orderId=data?.[0]?.id||null;
    if(!orderId){
      const ins={ client_id:c.id, client:c.name, phone:c.phone||null, notes:($('#oNotes').value||'').trim()||null, status:'zamówione', created_at:nowISO() };
      const ret = await db.from('seedorders_orders').insert(ins).select('id').single(); orderId=ret.data.id;
    }
    return orderId;
  }
  async function addOrderItem(){
    const orderId=await upsertOrderForSelectedClient(); if(!orderId) return;
    const item={ order_id:orderId, kategoria:$('#oKategoria').value, odmiana:($('#oOdmiana').value||'').trim(),
      ordered_qty:Number($('#oQty').value||0), delivered_qty:0, cena:Number($('#oPrice').value||null)||null, dostawca:($('#oVendor').value||'').trim()||null, created_at:nowISO() };
    if(!item.odmiana){ alert('Wybierz odmianę.'); return; }
    if(item.ordered_qty<=0){ alert('Podaj ilość ≥ 1'); return; }
    await db.from('seedorders_items').insert(item); await loadOrders(); await loadReport();
  }

  async function loadOrders(){
    const { data } = await db.from('seedorders_orders').select('id,client,phone,notes,status,created_at').order('created_at',{ascending:false}).limit(100);
    orders=data||[]; await renderOrders();
  }
  async function loadItemsFor(orderId){
    const { data } = await db.from('seedorders_items').select('id,kategoria,odmiana,cena,dostawca,ordered_qty,delivered_qty,ilosc,wydano').eq('order_id',orderId);
    return (data||[]).map(r=>({ id:r.id,kategoria:r.kategoria,odmiana:r.odmiana,cena:r.cena,dostawca:r.dostawca,
      ordered:r.ordered_qty ?? r.ilosc ?? 0, delivered:r.delivered_qty ?? r.wydano ?? 0 }));
  }
  async function updateOrderStatusByItems(orderId){
    const { data } = await db.from('seedorders_items').select('ordered_qty,delivered_qty,ilosc,wydano').eq('order_id',orderId);
    let sumOrd=0,sumDel=0; for(const r of (data||[])){ const o=r.ordered_qty ?? r.ilosc ?? 0; const d=r.delivered_qty ?? r.wydano ?? 0; sumOrd+=Number(o||0); sumDel+=Number(d||0); }
    const status = (sumDel<=0)?'zamówione':(sumDel<sumOrd?'częściowo':'dostarczone');
    await db.from('seedorders_orders').update({status}).eq('id',orderId);
  }
  async function changeDelivery(itemId,delta){
    const { data } = await db.from('seedorders_items').select('id,ordered_qty,delivered_qty,ilosc,wydano,order_id').eq('id',itemId).single();
    const ord=data.ordered_qty ?? data.ilosc ?? 0; const del=data.delivered_qty ?? data.wydano ?? 0; const next=Math.max(0,Math.min(ord,del+delta));
    const upd={}; if('delivered_qty' in data) upd.delivered_qty=next; if('wydano' in data) upd.wydano=next;
    await db.from('seedorders_items').update(upd).eq('id',itemId);
    await updateOrderStatusByItems(data.order_id); await loadOrders(); await loadReport();
  }
  async function setDeliveredExact(itemId,orderId,inputEl){
    const n=Number(inputEl.value||0); if(isNaN(n)||n<0){ alert('Nieprawidłowa ilość.'); return; }
    const { data } = await db.from('seedorders_items').select('ordered_qty,ilosc').eq('id',itemId).single();
    const ord=data?.ordered_qty ?? data?.ilosc ?? 0; const val=Math.max(0,Math.min(ord,n));
    await db.from('seedorders_items').update({delivered_qty:val,wydano:val}).eq('id',itemId);
    await updateOrderStatusByItems(orderId); await loadOrders(); await loadReport();
  }
  async function deleteOrderItem(itemId,orderId){
    if(!confirm('Usunąć pozycję?')) return;
    await db.from('seedorders_items').delete().eq('id',itemId);
    await updateOrderStatusByItems(orderId); await loadOrders(); await loadReport();
  }
  async function deleteOrder(orderId){
    if(!confirm('Usunąć całe zamówienie?')) return;
    await db.from('seedorders_items').delete().eq('order_id',orderId);
    await db.from('seedorders_orders').delete().eq('id',orderId);
    await loadOrders(); await loadReport();
  }

  function __rankStatus(s){ if(s==='dostarczone') return 2; if(s==='częściowo') return 1; return 0; }
  async function renderOrders(){
    const q = ($('#oSearch').value||'').toLowerCase();
    const only=$('#oStatusFilter').value; const box=$('#ordersContainer'); box.innerHTML='';
    const sorted=(orders||[]).slice().sort((a,b)=>{ const r=__rankStatus(a.status||'')-__rankStatus(b.status||''); if(r!==0) return r; return new Date(b.created_at)-new Date(a.created_at); });
    for(const o of sorted){
      const items=await loadItemsFor(o.id);
      const hay=(`${o.client||''} ${o.notes||''} `+items.map(i=>i.odmiana).join(' ')).toLowerCase();
      if(q && !hay.includes(q)) continue; if(only && o.status!==only) continue;
      const totalOrd=items.reduce((a,b)=>a+(b.ordered||0),0);
      const totalDel=items.reduce((a,b)=>a+(b.delivered||0),0);
      const totalRem=Math.max(0,totalOrd-totalDel);
      let cls='sok', label='zamówione'; if(totalDel>0 && totalDel<totalOrd){ cls='swarn'; label='częściowo'; } if(totalRem===0 && totalOrd>0){ cls='sdanger'; label='dostarczone'; }
      const card=document.createElement('div'); card.className='order';
      card.innerHTML=`
        <div class="order-header">
          <span class="status ${cls}">${label}</span>
          <span class="chip">${new Date(o.created_at).toLocaleString('pl-PL')}</span>
          <b>${o.client||''}</b>
          <span class="muted">${o.phone||''}</span>
          <span class="chip">Uwagi: ${o.notes||''}</span>
          <span class="right"></span>
          <select data-st="${o.id}">
            <option ${o.status==='zamówione'?'selected':''}>zamówione</option>
            <option ${o.status==='częściowo'?'selected':''}>częściowo</option>
            <option ${o.status==='dostarczone'?'selected':''}>dostarczone</option>
          </select>
          <button class="btn-sm danger" data-del="${o.id}">Usuń</button>
        </div>
        <div class="order-body">
          <table class="table">
            <thead><tr><th>Kategoria</th><th>Odmiana</th><th>Cena</th><th>Zamówiono</th><th>Wydano</th><th>Pozostało</th><th>Wydaj</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>`;
      const tbody=card.querySelector('tbody');
      for(const it of items){
        const ord=it.ordered||0, del=it.delivered||0, rem=Math.max(0,ord-del);
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${it.kategoria||''}</td>
          <td>${it.odmiana||''}</td>
          <td>${Number(it.cena||0).toFixed(2)}</td>
          <td>${fmt(ord)}</td>
          <td>${fmt(del)}</td>
          <td>${fmt(rem)}</td>
          <td>
            <div class="pill">
              <button class="btn-sm ghost" data-minus="${it.id}">−1</button>
              <button class="btn-sm ghost" data-plus="${it.id}">+1</button>
              <input class="kbd" type="number" min="0" step="1" placeholder="szt." data-exact="${it.id}" style="width:90px" />
              <button class="btn-sm primary" data-set="${it.id}">Ustaw</button>
            </div>
          </td>
          <td><button class="btn-sm danger" data-delete="${it.id}" data-order="${o.id}">Usuń</button></td>`;
        tbody.appendChild(tr);
      }
      card.querySelector(`[data-del="${o.id}"]`).onclick=()=>deleteOrder(o.id);
      card.querySelector(`[data-st="${o.id}"]`).onchange=async e=>{ await db.from('seedorders_orders').update({status:e.target.value}).eq('id',o.id); await renderOrders(); };
      card.querySelectorAll('[data-minus]').forEach(b=>b.onclick=()=>changeDelivery(b.dataset.minus,-1));
      card.querySelectorAll('[data-plus]').forEach(b=>b.onclick=()=>changeDelivery(b.dataset.plus,+1));
      card.querySelectorAll('[data-delete]').forEach(b=>b.onclick=()=>deleteOrderItem(b.dataset.delete,b.dataset.order));
      card.querySelectorAll('[data-set]').forEach(b=>{ b.onclick=()=>{ const inp=card.querySelector(`[data-exact="${b.dataset.set}"]`); setDeliveredExact(b.dataset.set,o.id,inp); }; });
      $('#ordersContainer').appendChild(card);
    }
  }

  // ====== RAPORT ======
  function setDefaultReportRange(){ const d=new Date(), d2=new Date(); d.setDate(d.getDate()-30); $('#rFrom').value=d.toISOString().slice(0,10); $('#rTo').value=d2.toISOString().slice(0,10); }
  async function loadReport(){
    const from=$('#rFrom').value||'2000-01-01', to=$('#rTo').value||'2100-01-01', cat=$('#rCat').value;
    let q=db.from('seedorders_items').select('kategoria,odmiana,ordered_qty,delivered_qty,ilosc,wydano,created_at').gte('created_at',from).lte('created_at',to);
    if(cat) q=q.eq('kategoria',cat);
    const { data } = await q;
    const sums={};
    (data||[]).forEach(r=>{
      const key=`${r.kategoria}||${r.odmiana}`;
      if(!sums[key]) sums[key]={kat:r.kategoria,odm:r.odmiana,zam:0,wyd:0};
      const ord=r.ordered_qty ?? r.ilosc ?? 0, del=r.delivered_qty ?? r.wydano ?? 0;
      sums[key].zam += Number(ord||0); sums[key].wyd += Number(del||0);
    });
    const tbody=$('#reportT'); tbody.innerHTML='';
    Object.values(sums).forEach(s=>{
      const rem=Math.max(0,(s.zam||0)-(s.wyd||0));
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${s.kat}</td><td>${s.odm}</td><td>${fmt(s.zam)}</td><td>${fmt(s.wyd)}</td><td>${fmt(rem)}</td>`;
      tbody.appendChild(tr);
    });
    $('#rRange').textContent=`${from} → ${to}`;
  }

  // ====== START ======
  (async()=>{
    setDefaultReportRange();
    await setStatus();
    await loadPrices();
    await loadClients();
    fillOdmianyFor($('#oKategoria').value||'Rzepak');
    await loadOrders();
    await loadReport();
  })();

  // ====== ZDARZENIA UI ======
  $('#refreshAll')?.addEventListener('click', async ()=>{ await setStatus(); await loadPrices(); await loadClients(); await loadOrders(); await loadReport(); });
  $('#togglePrices')?.addEventListener('click', e=>{ const b=$('#pricesBody'); const btn=e.target; const hide=b.style.display!=='none'?true:false; b.style.display=hide?'none':'grid'; btn.textContent=hide?'Pokaż':'Ukryj'; });
  $('#toggleClients')?.addEventListener('click', e=>{ const b=$('#clientsBody'); const btn=e.target; const hide=b.style.display!=='none'?true:false; b.style.display=hide?'none':'grid'; btn.textContent=hide?'Pokaż':'Ukryj'; });

  $('#pSave')?.addEventListener('click', savePrice);
  $('#pSearch')?.addEventListener('input', renderPrices);
  $('#cSave')?.addEventListener('click', saveClient);
  $('#cDelete')?.addEventListener('click', deleteClient);
  $('#cSearch')?.addEventListener('input', renderClients);
  $('#cRefresh')?.addEventListener('click', loadClients);
  $('#addItem')?.addEventListener('click', addOrderItem);
  $('#oSearch')?.addEventListener('input', renderOrders);
  $('#oStatusFilter')?.addEventListener('change', renderOrders);
  $('#oReload')?.addEventListener('click', loadOrders);
  $('#rShow')?.addEventListener('click', loadReport);
  $('#rCSV')?.addEventListener('click', downloadCSV);

  // ====== CSV (z kolumną Pozost.) ======
  function downloadCSV(){
    const rows=[['Kategoria','Odmiana','Zamówiono','Wydano','Pozostało']];
    $$('#reportT tr').forEach(tr=>{
      const tds=tr.querySelectorAll('td');
      rows.push([tds[0].innerText,tds[1].innerText,tds[2].innerText,tds[3].innerText,tds[4].innerText]);
    });
    const csv=rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(';')).join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download=`seedorders_raport_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(a.href);
  }
  </script>
</div>
</body>
</html>
