<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SeedOrders — wspólna baza</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#121936; --muted:#9da7bf; --text:#e8eeff;
      --accent:#36d399; --accent2:#60a5fa; --line:#2a345a; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.4 ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg)}
    h1{font-size:22px;margin:0}
    h2{font-size:18px;margin:0}
    .wrap{max-width:1200px;margin:auto;padding:16px;display:grid;gap:16px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:8px}
    .grow{grid-column:span 6}
    .right{margin-left:auto}
    input,select,button,textarea{background:#0e1430;border:1px solid var(--line);color:var(--text);padding:8px;border-radius:10px;outline:none}
    input::placeholder,textarea::placeholder{color:#7481a8}
    button{background:#1b2345;cursor:pointer}
    button.primary{background:var(--accent);color:#042016;font-weight:600;border:0}
    button.warn{background:var(--warn);color:#2b1000;border:0}
    button.danger{background:var(--danger);color:#2b0000;border:0}
    button.ghost{background:transparent;border:1px solid #1b3153}
    .btn-sm{padding:6px 10px;border-radius:8px;font-size:12px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--line);padding:8px 10px;text-align:left}
    .muted{color:var(--muted)}
    .status{font-weight:700;padding:2px 8px;border-radius:999px}
    .sok{background:rgba(22,163,74,.15);color:#22c55e;border:1px solid rgba(34,197,94,.3)}
    .scz{background:rgba(245,158,11,.15);color:#f59e0b;border:1px solid rgba(245,158,11,.3)}
    .sdg{background:rgba(239,68,68,.15);color:#ef4444;border:1px solid rgba(239,68,68,.3)}
    .chip{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;background:rgba(0,0,0,.15);border:1px dashed var(--line)}
    .order{border:1px dashed var(--line);padding:8px 12px;border-radius:10px;background:#0e1430;margin-bottom:8px}
    .order-header{display:flex;gap:10px;align-items:center;border-bottom:1px dashed var(--line);padding-bottom:8px;margin-bottom:6px}
    .order-body{padding-top:6px}
    .small{font-size:12px}
    .kbdrow{gap:6px;display:flex}
    .sticky{position:sticky;top:0;z-index:10}
    .srch{min-width:240px}
    .right{text-align:right}
  </style>
</head>
<body>
<div class="wrap">

  <!-- Pasek statusu -->
  <div class="panel sticky">
    <div class="flex">
      <h1>SeedOrders — wspólna baza</h1>
      <span id="status" class="chip">status…</span>
      <span class="chip small">czas: <span id="ts"></span></span>
      <span class="right"></span>
      <button id="refreshAll" class="ghost">Odśwież wszystko</button>
    </div>
  </div>

  <!-- Cennik (prosta lista pod podpowiedzi odmian) -->
  <div class="panel">
    <div class="flex">
      <h2>Cennik (seedorders_prices)</h2>
      <span class="right"></span>
      <button id="togglePrices" class="ghost btn-sm">Ukryj</button>
    </div>
    <div id="pricesBody" class="grid">
      <div class="row">
        <select id="pKategoria">
          <option value="Rzepak">Rzepak</option>
          <option value="Kukurydza">Kukurydza</option>
          <option value="Zboża">Zboża</option>
          <option value="Trawy">Trawy</option>
          <option value="Inne">Inne</option>
        </select>
        <input id="pOdmiana" placeholder="Odmiana" />
        <input id="pCena" type="number" step="0.01" placeholder="Cena / szt." />
        <input id="pDostawca" placeholder="Dostawca (opcjonalnie)" />
        <button id="pSave" class="primary">Zapisz</button>
        <input id="pSearch" class="srch" placeholder="Szukaj w cenniku…" />
      </div>
      <table class="table" id="pricesTable">
        <thead><tr><th>Odmiana</th><th>Kategoria</th><th>Cena</th><th>Dostawca</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Kontrahenci -->
  <div class="panel">
    <div class="flex">
      <h2>Kontrahenci (seedorders_clients)</h2>
      <span class="right"></span>
      <button id="toggleClients" class="ghost btn-sm">Ukryj</button>
    </div>
    <div id="clientsBody" class="grid">
      <div class="row">
        <input id="cName" class="grow" placeholder="Nazwa (np. Jan Kowalski)" />
        <input id="cPhone" placeholder="Telefon" />
        <input id="cAddress" placeholder="Adres (ulica, kod, miejscowość, kraj)" class="grow" />
        <button id="cSave" class="primary">Zapisz</button>
        <button id="cDelete" class="danger">Usuń</button>
        <span class="right"></span>
        <input id="cSearch" class="srch" placeholder="Szukaj klienta…" />
        <button id="cRefresh" class="ghost">Odśwież listę</button>
      </div>
      <table class="table" id="clientsTable">
        <thead><tr><th>Nazwa</th><th>Telefon</th><th>Adres</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Dodaj zamówienie -->
  <div class="panel">
    <div class="flex">
      <h2>Dodaj zamówienie</h2>
    </div>
    <div class="row">
      <select id="oClient" class="grow"></select>
      <input id="oPhone" placeholder="Telefon (auto)" disabled />
      <select id="oKategoria">
        <option value="Rzepak">Rzepak</option>
        <option value="Kukurydza">Kukurydza</option>
        <option value="Zboża">Zboża</option>
        <option value="Trawy">Trawy</option>
        <option value="Inne">Inne</option>
      </select>
      <select id="oOdmiana" class="grow"><option value="">Odmiana (wg kategorii)</option></select>
      <input id="oQty" type="number" step="1" value="1" />
      <input id="oPrice" type="number" step="0.01" placeholder="Cena / szt." />
      <input id="oVendor" placeholder="Dostawca (opcjonalnie)" />
      <input id="oNotes" placeholder="Uwagi (opcjonalnie)" class="grow" />
      <button id="oAddItem" class="primary">Dodaj pozycję</button>
    </div>

    <div class="flex" style="margin-top:10px">
      <h2>Zamówienia (ostatnie)</h2>
      <span class="right"></span>
      <input id="oSearch" class="srch" placeholder="Szukaj: klient/odmiana/uwagi…" />
      <select id="oStatusFilter">
        <option value="">Wszystkie statusy</option>
        <option value="zamówione">zamówione</option>
        <option value="częściowo">częściowo</option>
        <option value="dostarczone">dostarczone</option>
      </select>
      <button id="oReload" class="ghost">Odśwież</button>
    </div>

    <div id="ordersContainer"></div>
  </div>

  <!-- Raport -->
  <div class="panel">
    <div class="flex">
      <h2>Raport</h2>
    </div>
    <div class="row">
      <input id="rFrom" type="date" />
      <input id="rTo" type="date" />
      <select id="rCat">
        <option value="Wszystkie">(Wszystkie)</option>
        <option value="Rzepak">Rzepak</option>
        <option value="Kukurydza">Kukurydza</option>
        <option value="Zboża">Zboża</option>
        <option value="Trawy">Trawy</option>
        <option value="Inne">Inne</option>
      </select>
      <button id="rShow" class="ghost">Pokaż</button>
      <button id="rCSV" class="primary">Pobierz CSV</button>
    </div>
    <table class="table" id="reportTable" style="margin-top:10px">
      <thead><tr><th>Kategoria</th><th>Odmiana</th><th>Zamówiono</th><th>Wydano</th><th>Pozostało</th><th>Wartość</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="small muted">Zakres: <span id="rRange"></span></div>
  </div>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
// ====== KONFIGURACJA SUPABASE (WSTAW SWOJE KLUCZE) ======
const SUPABASE_URL  = "https://zseqkyjcqkuvrqxluihs.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzZXFreWpjcWt1dnJxeGx1aWhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNDk2NjUsImV4cCI6MjA3NjkyNTY2NX0.ubbYQzYWiMyETohwKRnVQZaZRoIA-zwiX2YsY8TPsDk";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{ persistSession:false }});

// ====== POMOCNICZE ======
const $  = (sel)=> document.querySelector(sel);
const $$ = (sel)=> document.querySelectorAll(sel);
const fmt = (n)=> (n??0).toLocaleString('pl-PL');
const nowISO = ()=> new Date().toISOString();
const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));

const CAT_FLAGS = {
  'Rzepak':'#Rzepak','Kukurydza':'#Kukurydza','Zboża':'#Zboża','Trawy':'#Trawy','Inne':'#Inne'
};

// ====== STATUS ======
async function setStatus(){
  const { error } = await db.from('seedorders_prices').select('id').limit(1);
  const s = $('#status');
  if(error){ s.textContent='status: offline'; s.className='chip sdg'; }
  else { s.textContent='status: online'; s.className='chip sok'; }
  $('#ts').textContent = new Date().toLocaleTimeString('pl-PL');
}

// ====== CENNIK ======
let prices = [];
let selectedPriceId = null;
function categoryAllowed(kat){
  return !!CAT_FLAGS[kat];
}

async function loadPrices(){
  const { data, error } = await db.from('seedorders_prices')
    .select('id,odmiana,kategoria,cena,dostawca,created_at')
    .order('odmiana', {ascending:true});
  if(error){ console.error(error); return; }
  prices = data || [];
  renderPrices();
  fillOdmianyFor($('#oKategoria').value);
}

function renderPrices(){
  const q = ($('#pSearch').value||'').toLowerCase();
  const tbody = $('#pricesTable tbody');
  tbody.innerHTML = '';
  prices
    .filter(r => !q || (`${r.odmiana} ${r.kategoria} ${r.dostawca||''}`).toLowerCase().includes(q))
    .forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${r.odmiana}</td>
        <td>${r.kategoria}</td>
        <td>${r.cena ?? ''}</td>
        <td>${r.dostawca||''}</td>
        <td><button class="btn-sm ghost">Edytuj</button></td>`;
      tr.querySelector('button').onclick=()=>{
        selectedPriceId = r.id;
        $('#pOdmiana').value = r.odmiana;
        $('#pKategoria').value = r.kategoria;
        $('#pCena').value = r.cena ?? '';
        $('#pDostawca').value = r.dostawca || '';
      };
      tbody.appendChild(tr);
    });
}

async function savePrice(){
  const row = {
    odmiana: $('#pOdmiana').value.trim(),
    kategoria: $('#pKategoria').value,
    cena: ($('#pCena').value==='' ? null : Number($('#pCena').value)),
    dostawca: ($('#pDostawca').value || null),
    created_at: nowISO()
  };
  if(!row.odmiana){ alert('Podaj odmianę.'); return; }

  if(selectedPriceId){
    const { error } = await db.from('seedorders_prices').update(row).eq('id', selectedPriceId);
    if(error){ alert('Błąd cennika (edycja): '+error.message); return; }
  }else{
    const { error } = await db.from('seedorders_prices').insert(row);
    if(error){ alert('Błąd cennika (zapis): '+error.message); return; }
  }
  selectedPriceId = null;
  $('#pOdmiana').value=''; $('#pKategoria').value='Rzepak'; $('#pCena').value=''; $('#pDostawca').value='';
  await loadPrices();
}

async function deletePrice(){
  if(!selectedPriceId){ alert('Najpierw wybierz pozycję (Edytuj).'); return; }
  if(!confirm('Usunąć pozycję z cennika?')) return;
  const { error } = await db.from('seedorders_prices').delete().eq('id', selectedPriceId);
  if(error){ alert('Błąd usuwania: '+error.message); return; }
  selectedPriceId=null;
  await loadPrices();
}

// ====== KONTRAHENCI ======
let clients = [];
let selectedClientId = null;

async function loadClients(){
  const { data, error } = await db.from('seedorders_clients')
    .select('id,name,phone,address')
    .order('name',{ascending:true});
  if(error){ console.error(error); return; }
  clients = data || [];
  renderClients();
  fillClientsSelect();
}

function renderClients(){
  const q = ($('#cSearch').value||'').toLowerCase();
  const tbody = $('#clientsTable tbody'); tbody.innerHTML='';
  (clients||[])
   .filter(r => !q || (`${r.name||''} ${r.phone||''} ${r.address||''}`).toLowerCase().includes(q))
   .forEach(r=>{
     const tr=document.createElement('tr');
     tr.innerHTML = `<td>${r.name||''}</td><td>${r.phone||''}</td><td>${r.address||''}</td><td><button class="btn-sm ghost">Edytuj</button></td>`;
     tr.querySelector('button').onclick=()=>{
       selectedClientId = r.id;
       $('#cName').value = r.name||'';
       $('#cPhone').value = r.phone||'';
       $('#cAddress').value = r.address||'';
     };
     tbody.appendChild(tr);
   });
}

function fillClientsSelect(){
  const sel = $('#oClient'); sel.innerHTML='';
  clients.forEach(c=>{
    const opt=document.createElement('option'); opt.value=c.id; opt.textContent=c.name;
    sel.appendChild(opt);
  });
  const cur = clients.find(c=> c.id===sel.value);
  $('#oPhone').value = cur ? (cur.phone||'') : '';
}
$('#oClient').addEventListener('change', ()=>{
  const id = $('#oClient').value;
  const c = clients.find(x=>x.id===id);
  $('#oPhone').value = (c?.phone)||'';
});

async function saveClient(){
  const row = {
    name: $('#cName').value.trim(),
    phone: $('#cPhone').value||null,
    address: $('#cAddress').value.trim()||null
  };
  if(!row.name){ alert('Podaj nazwę kontrahenta.'); return; }

  if(selectedClientId){
    const { error } = await db.from('seedorders_clients').update(row).eq('id', selectedClientId);
    if(error){ alert('Błąd edycji klienta: '+error.message); return; }
  }else{
    const { error } = await db.from('seedorders_clients').insert(row);
    if(error){ alert('Błąd dodawania klienta: '+error.message); return; }
  }
  selectedClientId=null; $('#cName').value=''; $('#cPhone').value=''; $('#cAddress').value='';
  await loadClients();
}
async function deleteClient(){
  if(!selectedClientId){ alert('Najpierw wybierz klienta (Edytuj).'); return; }
  if(!confirm('Usunąć klienta?')) return;
  const { error } = await db.from('seedorders_clients').delete().eq('id', selectedClientId);
  if(error){ alert('Błąd usuwania klienta: '+error.message); return; }
  selectedClientId=null; await loadClients();
}

// ====== ODMIANY DLA KATEGORII (z cennika) ======
function fillOdmianyFor(kat){
  const sel = $('#oOdmiana'); sel.innerHTML='<option value="">Odmiana (wg kategorii)</option>';
  prices.filter(p => p.kategoria===kat).forEach(p=>{
    const o=document.createElement('option');
    o.value=p.odmiana; o.textContent = `${p.odmiana}${p.dostawca?' ⎯ '+p.dostawca:''}${p.cena!=null?' ('+Number(p.cena).toFixed(2)+' zł)':''}`;
    sel.appendChild(o);
  });
}
$('#oKategoria').addEventListener('change', ()=> fillOdmianyFor($('#oKategoria').value));

// ====== ZAMÓWIENIA ======
async function upsertOrderForSelectedClient(){
  const id  = $('#oClient').value;
  const c   = clients.find(x=>x.id===id);
  if(!c){ alert('Wybierz klienta.'); return null; }

  // czy jest już nagłówek dzisiejszy „zamówione” dla tego klienta?
  const { data, error } = await db.from('seedorders_orders')
    .select('id,created_at').eq('client_id', id).order('created_at',{ascending:false}).limit(1);
  if(error){ alert('Błąd odczytu zamówień: '+error.message); return null; }

  let orderId = (data && data[0]?.id) || null;
  if(!orderId){
    const ins = {
      client_id: c.id,
      client: c.name,
      phone: c.phone||null,
      notes: ($('#oNotes').value||null),
      status: 'zamówione',
      created_at: nowISO()
    };
    const { data:created, error:err2 } = await db.from('seedorders_orders').insert(ins).select('id').single();
    if(err2){ alert('Błąd tworzenia nagłówka zamówienia: '+err2.message); return null; }
    orderId = created.id;
  }
  return orderId;
}

async function addOrderItem(){
  const orderId = await upsertOrderForSelectedClient();
  if(!orderId) return;

  const kat    = $('#oKategoria').value;
  const odm    = $('#oOdmiana').value.trim();
  if(!odm){ alert('Wybierz odmianę.'); return; }
  const qty    = Number($('#oQty').value||0); if(qty<=0){ alert('Podaj ilość > 0.'); return; }
  const price  = ($('#oPrice').value===''? null : Number($('#oPrice').value));
  const vendor = ($('#oVendor').value||null);

  // łączenie duplikatów: ten sam towar/cena/dostawca
  const { data:exist, error:e0 } = await db.from('seedorders_items')
    .select('id, ordered_qty').eq('order_id', orderId)
    .eq('kategoria', kat).eq('odmiana', odm)
    .eq('cena', price).eq('dostawca', vendor).maybeSingle();
  if(e0){ alert('Błąd sprawdzania pozycji: '+e0.message); return; }

  if(exist){
    const { error:uerr } = await db.from('seedorders_items')
      .update({ ordered_qty: (exist.ordered_qty||0)+qty }).eq('id', exist.id);
    if(uerr){ alert('Błąd aktualizacji pozycji: '+uerr.message); return; }
  }else{
    const row = {
      order_id: orderId, kategoria: kat, odmiana: odm,
      cena: price, dostawca: vendor,
      ordered_qty: qty, delivered_qty: 0, created_at: nowISO()
    };
    const { error:insErr } = await db.from('seedorders_items').insert(row);
    if(insErr){ alert('Błąd pozycji: '+insErr.message); return; }
  }

  $('#oOdmiana').value=''; $('#oQty').value='1'; $('#oPrice').value=''; $('#oVendor').value='';
  await loadOrders(); await loadReport();
}

async function changeDelivery(itemId, value){
  const { error } = await db.from('seedorders_items').update({ delivered_qty:Number(value||0) }).eq('id', itemId);
  if(error){ alert('Błąd wydania: '+error.message); return; }
}

async function updateOrderStatusByItems(orderId){
  const { data, error } = await db.from('seedorders_items')
    .select('ordered_qty,delivered_qty').eq('order_id', orderId);
  if(error) return;
  let totalOrd=0,totalDel=0;
  data.forEach(r=>{
    totalOrd += (r.ordered_qty||0);
    totalDel += (r.delivered_qty||0);
  });
  let status='zamówione';
  if(totalDel>0 && totalDel<totalOrd) status='częściowo';
  if(totalDel>0 && totalDel>=totalOrd) status='dostarczone';
  await db.from('seedorders_orders').update({status}).eq('id', orderId);
}

async function deleteItem(itemId, orderId){
  if(!confirm('Usunąć pozycję?')) return;
  const { error } = await db.from('seedorders_items').delete().eq('id', itemId);
  if(error){ alert('Błąd usuwania: '+error.message); return; }
  await updateOrderStatusByItems(orderId);
  await loadOrders(); await loadReport();
}

async function deleteOrder(orderId){
  if(!confirm('Usunąć całe zamówienie?')) return;
  await db.from('seedorders_items').delete().eq('order_id', orderId);
  await db.from('seedorders_orders').delete().eq('id', orderId);
  await loadOrders(); await loadReport();
}

async function loadItems(orderId){
  const { data, error } = await db.from('seedorders_items')
    .select('id,kategoria,odmiana,cena,dostawca,ordered_qty,delivered_qty,order_id')
    .eq('order_id', orderId);
  if(error){ console.error(error); return []; }
  return (data||[]).map(r=>({
    id:r.id, kategoria:r.kategoria, odmiana:r.odmiana, cena:r.cena,
    vendor:r.dostawca, ordered:r.ordered_qty||0, delivered:r.delivered_qty||0,
    remaining: Math.max(0,(r.ordered_qty||0)-(r.delivered_qty||0))
  }));
}

let orders = [];
async function loadOrders(){
  const q = ($('#oSearch').value||'').toLowerCase();
  const only = $('#oStatusFilter').value;
  const { data, error } = await db.from('seedorders_orders')
    .select('id,client,phone,notes,status,created_at').order('created_at',{ascending:false}).limit(100);
  if(error){ console.error(error); return; }
  orders = data || [];
  await renderOrders(q, only);
}

async function renderOrders(q, only){
  const box = $('#ordersContainer'); box.innerHTML='';
  for(const o of orders){
    const items = await loadItems(o.id);
    const hay = `${o.client||''} ${o.notes||''} ${items.map(i=>i.odmiana).join(' ')}`.toLowerCase();
    if(q && !hay.includes(q)) continue;
    if(only && o.status!==only) continue;

    // kolor/status
    let cls='sok', label='zamówione';
    if(o.status==='częściowo'){ cls='scz'; label='częściowo'; }
    if(o.status==='dostarczone'){ cls='sdg'; label='dostarczone'; }

    const card = document.createElement('div');
    card.className='order';
    card.innerHTML = `
      <div class="order-header">
        <span class="status ${cls}">${label}</span>
        <span class="chip">${new Date(o.created_at).toLocaleString('pl-PL')}</span>
        <b>${o.client||''}</b>
        <span class="chip muted">${o.phone||'—'}</span>
        <span class="chip">Pozostało: <span class="muted" id="rem"></span></span>
        <span class="chip">Uwagi: ${o.notes||'—'}</span>
        <span class="right"></span>
        <button class="btn-sm ghost" data-del="${o.id}">Usuń</button>
      </div>
      <div class="order-body">
        <table class="table">
          <thead>
            <tr><th>Kategoria</th><th>Odmiana</th><th>Ilość</th><th>Cena</th><th>Wartość</th><th>Wydaj</th><th>Akcje</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    `;

    const tbody = card.querySelector('tbody');
    let totalRem=0, totalVal=0;

    items.forEach(it=>{
      totalRem += (it.remaining||0);
      const wartosc = ((it.cena??0)*(it.ordered??0))||0;
      totalVal += wartosc;

      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${it.kategoria}</td>
        <td>${it.odmiana}</td>
        <td><input type="number" class="ed-qty" min="1" value="${it.ordered}" style="width:80px"></td>
        <td><input type="number" class="ed-price" step="0.01" value="${it.cena??''}" style="width:100px"></td>
        <td class="right">${fmt(wartosc)} zł</td>
        <td><input type="number" class="ed-del" min="0" max="${it.ordered}" value="${it.delivered}" style="width:80px"></td>
        <td class="kbdrow">
          <button class="btn-sm ghost save">Zapisz</button>
          <button class="btn-sm">Wydaj</button>
          <button class="btn-sm danger">Usuń</button>
        </td>
      `;
      const edQty   = tr.querySelector('.ed-qty');
      const edPrice = tr.querySelector('.ed-price');
      const edDel   = tr.querySelector('.ed-del');

      tr.querySelector('.save').onclick = async ()=>{
        const upd = {
          ordered_qty: Number(edQty.value||0),
          cena: (edPrice.value===''? null : Number(edPrice.value))
        };
        const { error } = await db.from('seedorders_items').update(upd).eq('id', it.id);
        if(error){ alert('Błąd zapisu pozycji: '+error.message); return; }
        await updateOrderStatusByItems(o.id);
        await loadOrders(); await loadReport();
      };
      tr.querySelector('.btn-sm:not(.save):not(.danger)').onclick = async ()=>{
        await changeDelivery(it.id, edDel.value);
        await updateOrderStatusByItems(o.id);
        await loadOrders(); await loadReport();
      };
      tr.querySelector('.danger').onclick = ()=> deleteItem(it.id, o.id);

      tbody.appendChild(tr);
    });

    // wiersz sumy
    const trSum = document.createElement('tr');
    trSum.innerHTML = `<td colspan="4"><b>RAZEM:</b></td><td class="right"><b>${fmt(totalVal)} zł</b></td><td colspan="2"></td>`;
    tbody.appendChild(trSum);

    // aktualizuj licznik „Pozostało”
    card.querySelector('#rem').textContent = fmt(totalRem);

    // nagłówkowe akcje
    card.querySelector(`[data-del="${o.id}"]`).onclick = ()=> deleteOrder(o.id);

    box.appendChild(card);
  }
}

// ====== RAPORT ======
function setDefaultReportRange(){
  const d=new Date(), d2=new Date(); d2.setDate(d.getDate()-30);
  $('#rFrom').value = d2.toISOString().slice(0,10);
  $('#rTo').value   = d.toISOString().slice(0,10);
}

async function loadReport(){
  const from = $('#rFrom').value || '2000-01-01';
  const to   = $('#rTo').value   || '2100-01-01';
  const cat  = $('#rCat').value;

  let query = db.from('seedorders_items')
    .select('odmiana,kategoria,ordered_qty,delivered_qty,created_at,cena')
    .gte('created_at', from).lte('created_at', to);
  if(cat && cat!=='Wszystkie') query = query.eq('kategoria', cat);

  const { data, error } = await query;
  if(error){ alert('Błąd raportu: '+error.message); return; }

  const sums = {};
  data.forEach(r=>{
    const key = `${r.kategoria}||${r.odmiana}`;
    if(!sums[key]) sums[key] = { kategoria:r.kategoria, odmiana:r.odmiana, zam:0, wyd:0, wart:0 };
    sums[key].zam  += (r.ordered_qty||0);
    sums[key].wyd  += (r.delivered_qty||0);
    sums[key].wart += ((r.cena||0)*(r.ordered_qty||0));
  });

  const tbody = $('#reportTable tbody'); tbody.innerHTML='';
  let total=0;
  Object.values(sums)
    .sort((a,b)=> (a.kategoria.localeCompare(b.kategoria) || a.odmiana.localeCompare(b.odmiana)))
    .forEach(r=>{
      const wart = r.wart||0; total+=wart;
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${r.kategoria}</td><td>${r.odmiana}</td><td>${fmt(r.zam)}</td><td>${fmt(r.wyd)}</td><td>${fmt(Math.max(0,r.zam-r.wyd))}</td><td class="right">${fmt(wart)} zł</td>`;
      tbody.appendChild(tr);
    });
  const trSum=document.createElement('tr');
  trSum.innerHTML = `<td colspan="5"><b>RAZEM:</b></td><td class="right"><b>${fmt(total)} zł</b></td>`;
  tbody.appendChild(trSum);
  $('#rRange').textContent = `${from} — ${to}`;
}

function downloadCSV(){
  const rows=[['Kategoria','Odmiana','Zamówiono','Wydano','Pozostało','Wartość']];
  $('#reportTable tbody tr').forEach(tr=>{
    const cells=[...tr.children].map(td=>td.textContent.trim());
    if(cells[0]!=='RAZEM:') rows.push(cells);
  });
  const csv = rows.map(r=>r.map(v=>String(v).replaceAll('"','""')).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`raport_${$('#rFrom').value}_${$('#rTo').value}.csv`; a.click();
}

// ====== ZDARZENIA UI ======
$('#refreshAll').onclick = async ()=>{ await setStatus(); await loadPrices(); await loadClients(); await loadOrders(); await loadReport(); };

$('#togglePrices').onclick = ()=>{
  const b=$('#pricesBody'); const btn=$('#togglePrices'); const hide=b.style.display==='none'; b.style.display = hide?'':'none'; btn.textContent = hide?'Ukryj':'Pokaż';
};
$('#toggleClients').onclick = ()=>{
  const b=$('#clientsBody'); const btn=$('#toggleClients'); const hide=b.style.display==='none'; b.style.display = hide?'':'none'; btn.textContent = hide?'Ukryj':'Pokaż';
};

$('#pSave').onclick = savePrice; $('#pDelete').onclick=deletePrice; $('#pSearch').oninput=renderPrices;
$('#cSave').onclick=saveClient; $('#cDelete').onclick=deleteClient; $('#cSearch').oninput=renderClients; $('#cRefresh').onclick=loadClients;

$('#oAddItem').onclick=addOrderItem; $('#oSearch').oninput=()=>renderOrders(($('#oSearch').value||'').toLowerCase(), $('#oStatusFilter').value);
$('#oStatusFilter').onchange=()=>renderOrders(($('#oSearch').value||'').toLowerCase(), $('#oStatusFilter').value);
$('#oReload').onclick=loadOrders;

$('#rShow').onclick=loadReport; $('#rCSV').onclick=downloadCSV;

// ====== START ======
(async function boot(){
  setDefaultReportRange();
  await setStatus();
  await loadPrices();
  await loadClients();
  fillOdmianyFor($('#oKategoria').value);
  await loadOrders();
  await loadReport();
})();
</script>
</body>
</html>

